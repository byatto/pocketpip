<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>pocketpip</title>
<link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cpath d='M10 50 A 40 40 0 0 0 90 50 A 40 40 0 0 0 50 10 L 10 10 Z' fill='%235b8c5a'/%3E%3Ctext x='48' y='72' font-family='Nunito, sans-serif' font-size='60' font-weight='800' fill='white' text-anchor='middle'%3Ep%3C/text%3E%3C/svg%3E" type="image/svg+xml">
<link href="https://fonts.googleapis.com/css2?family=Fraunces:ital,opsz,wght@0,9..144,400;0,9..144,500;1,9..144,400&family=Nunito:ital,wght@0,400;0,500;0,600;0,700;1,400&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
  :root, [data-theme="light"] {
    --bg: #f4f7f4; --bg-surface: #ffffff; --bg-elevated: #ffffff; --bg-hover: #eaf0ea; --bg-nav: #e4ece4; 
    --border: #d0dfd0; --border-subtle: #dfe8df; --text: #2d3b2d; --text-secondary: #526652; --text-muted: #8ba38b; 
    --accent: #5b8c5a; --accent-dim: #4a7549; --accent-glow: rgba(91,140,90,.12); 
    --cat-quote: #788566; --cat-quote-bg: rgba(120,133,102,.10); 
    --cat-first: #5b8c5a; --cat-first-bg: rgba(91,140,90,.12); 
    --cat-funny: #e09f3e; --cat-funny-bg: rgba(224,159,62,.12); 
    --cat-note: #64839c; --cat-note-bg: rgba(100,131,156,.10); 
    --danger: #c95c55; --danger-bg: rgba(201,92,85,.08); 
    --undo-bg: #2d3b2d; --undo-text: #f4f7f4; --modal-overlay: rgba(244,247,244,.85);
  }
  [data-theme="dark"] {
    --bg: #161a16; --bg-surface: #1e241e; --bg-elevated: #252c25; --bg-hover: #2a332a; --bg-nav: #1a201a; 
    --border: #334033; --border-subtle: #283328; --text: #e4ece4; --text-secondary: #a1bba1; --text-muted: #6e856e; 
    --accent: #7ebc7d; --accent-dim: #679e66; --accent-glow: rgba(126,188,125,.12); 
    --cat-quote: #9fa88f; --cat-quote-bg: rgba(159,168,143,.12); 
    --cat-first: #7ebc7d; --cat-first-bg: rgba(126,188,125,.14); 
    --cat-funny: #ebb86c; --cat-funny-bg: rgba(235,184,108,.14); 
    --cat-note: #8ba4b8; --cat-note-bg: rgba(139,164,184,.12); 
    --danger: #d4726a; --danger-bg: rgba(212,114,106,.10); 
    --undo-bg: #e4ece4; --undo-text: #161a16; --modal-overlay: rgba(22,26,22,.88);
  }
  :root {
    --radius: 10px; --radius-lg: 16px; --transition: 180ms ease; 
    --font: 'Nunito', -apple-system, BlinkMacSystemFont, sans-serif; 
    --font-display: 'Fraunces', Georgia, serif; 
    --mono: 'JetBrains Mono', monospace;
  }*{margin:0;padding:0;box-sizing:border-box}
  body{font-family:var(--font);background:var(--bg);color:var(--text);min-height:100vh;line-height:1.55;-webkit-font-smoothing:antialiased;transition:background 300ms ease,color 300ms ease}
  .app{max-width:680px;margin:0 auto;padding:0 20px;min-height:100vh;display:flex;flex-direction:column}

  /* HEADER */
  header{padding:28px 0 20px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border-subtle)}
  .header-left{display:flex;align-items:center;gap:14px}
  .logo{display:flex;align-items:center;gap:10px;cursor:default}
  .logo-mark {
    width: 34px;
    height: 34px;
    /* This creates the organic seed/leaf shape! */
    border-radius: 50% 50% 50% 6px; 
    background: linear-gradient(135deg, var(--accent), var(--accent-dim));
    display: flex;
    align-items: center;
    justify-content: center;
    font-family: 'Nunito', sans-serif;
    font-weight: 800;
    font-size: 22px;
    color: #fff;
    padding-bottom: 2px; /* Centers the 'p' visually */
    box-shadow: 0 4px 12px var(--accent-glow);
  }
  .logo-text{font-family:var(--font-display);font-size:18px;font-weight:400;color:var(--text)}

  /* CHILD SELECTOR */
  .child-selector{position:relative;display:inline-flex;align-items:center}
  .child-active-btn{display:inline-flex;align-items:center;gap:5px;font-family:var(--font);font-size:12px;font-weight:500;color:var(--accent);background:var(--accent-glow);border:1px solid rgba(196,149,106,.25);border-radius:20px;padding:4px 12px 4px 10px;cursor:pointer;transition:all var(--transition);white-space:nowrap}
  .child-active-btn:hover{border-color:rgba(196,149,106,.45);background:rgba(196,149,106,.18)}
  .child-arrow{font-size:9px;opacity:.6;margin-left:2px}
  .child-dropdown{position:absolute;top:calc(100% + 6px);left:0;min-width:180px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow-lg);z-index:300;display:none;overflow:hidden}
  .child-dropdown.open{display:block}
  .child-option{padding:9px 14px;font-size:13px;cursor:pointer;color:var(--text-secondary);transition:all var(--transition);display:flex;align-items:center;justify-content:space-between}
  .child-option:hover{background:var(--bg-hover);color:var(--text)}
  .child-option.active{color:var(--accent);font-weight:600}
  .child-option .child-remove{opacity:0;font-size:14px;color:var(--danger);cursor:pointer;padding:0 2px;transition:opacity 150ms;line-height:1}
  .child-option:hover .child-remove{opacity:.6}
  .child-option .child-remove:hover{opacity:1}
  .child-add-option{padding:9px 14px;font-size:13px;cursor:pointer;color:var(--accent);font-weight:500;border-top:1px solid var(--border-subtle);transition:background var(--transition)}
  .child-add-option:hover{background:var(--bg-hover)}

  .header-right{display:flex;align-items:center;gap:8px}
  .theme-toggle{width:32px;height:32px;border-radius:6px;border:1px solid var(--border-subtle);background:transparent;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:14px;transition:all var(--transition);color:var(--text-muted)}
  .theme-toggle:hover{border-color:var(--border);color:var(--text-secondary);background:var(--bg-hover)}

  nav{display:flex;gap:2px;background:var(--bg-nav);padding:3px;border-radius:var(--radius)}
  nav button{font-family:var(--font);font-size:13px;font-weight:500;padding:7px 16px;border:none;background:transparent;color:var(--text-muted);border-radius:6px;cursor:pointer;transition:all var(--transition);position:relative}
  nav button:hover{color:var(--text-secondary)}
  nav button.active{background:var(--bg-surface);color:var(--text);box-shadow:var(--shadow-sm)}
  nav button .badge{position:absolute;top:2px;right:4px;background:var(--accent);color:#fff;font-size:10px;font-weight:700;min-width:16px;height:16px;border-radius:8px;display:flex;align-items:center;justify-content:center;padding:0 4px}

  main{flex:1;padding:28px 0}

  /* CAPTURE */
  .capture-view{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:50vh}
  .capture-prompt{font-family:var(--font-display);font-style:italic;font-size:15px;color:var(--text-muted);margin-bottom:20px}
  .capture-input-wrap{width:100%;position:relative}
  .capture-input{width:100%;font-family:var(--font);font-size:18px;font-weight:300;padding:20px 22px;background:var(--bg-surface);border:1.5px solid var(--border);border-radius:var(--radius-lg);color:var(--text);outline:none;transition:all var(--transition);resize:none;line-height:1.55;min-height:72px;box-shadow:var(--shadow-sm)}
  .capture-input::placeholder{color:var(--text-muted);font-weight:300}
  .capture-input:focus{border-color:var(--accent);box-shadow:0 0 0 3px var(--accent-glow),var(--shadow-md)}
  .capture-char-count{position:absolute;bottom:8px;right:14px;font-family:var(--mono);font-size:10px;color:var(--text-muted);opacity:0;transition:opacity 200ms}
  .capture-input:focus~.capture-char-count{opacity:1}

  .category-bar{width:100%;display:flex;gap:6px;margin-top:14px;flex-wrap:wrap;align-items:center}
  .cat-chip{font-family:var(--font);font-size:13px;font-weight:500;padding:7px 16px;border:1.5px solid var(--border-subtle);background:transparent;border-radius:20px;cursor:pointer;transition:all var(--transition);color:var(--text-muted);-webkit-tap-highlight-color:transparent}
  .cat-chip:hover{border-color:var(--border);color:var(--text-secondary)}
  .cat-chip.selected{font-weight:600}
  .cat-chip[data-cat="quote"].selected{color:var(--cat-quote);background:var(--cat-quote-bg);border-color:rgba(122,111,90,.3)}
  .cat-chip[data-cat="first"].selected{color:var(--cat-first);background:var(--cat-first-bg);border-color:rgba(196,149,106,.35)}
  .cat-chip[data-cat="funny"].selected{color:var(--cat-funny);background:var(--cat-funny-bg);border-color:rgba(184,137,76,.35)}
  .cat-chip[data-cat="note"].selected{color:var(--cat-note);background:var(--cat-note-bg);border-color:rgba(138,154,122,.3)}

  .capture-meta{width:100%;display:flex;gap:10px;margin-top:10px;align-items:flex-start}
  .tag-container{flex:1;position:relative;background:var(--bg-surface);border:1px solid var(--border-subtle);border-radius:var(--radius);box-shadow:var(--shadow-sm);display:flex;flex-wrap:wrap;align-items:center;gap:6px;padding:6px 10px;transition:all var(--transition);min-height:40px}
  .tag-container:focus-within{border-color:var(--accent);box-shadow:0 0 0 2px var(--accent-glow)}
  .tag-chip{display:inline-flex;align-items:center;gap:4px;background:var(--bg-nav);color:var(--text);font-size:13px;padding:2px 8px;border-radius:4px;animation:chipIn 150ms ease}
  @keyframes chipIn{from{opacity:0;transform:scale(.85)}to{opacity:1;transform:scale(1)}}
  .tag-chip .tag-remove{cursor:pointer;opacity:.4;font-size:14px;margin-left:2px;line-height:1}
  .tag-chip .tag-remove:hover{opacity:1;color:var(--danger)}
  .tag-select-input{flex:1;min-width:70px;font-family:var(--font);font-size:13px;border:none;background:transparent;color:var(--text);outline:none;padding:4px 0}
  .tag-select-input::placeholder{color:var(--text-muted)}
  .tag-dropdown{position:absolute;top:calc(100% + 4px);left:0;right:0;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow-lg);z-index:100;max-height:180px;overflow-y:auto;display:none}
  .tag-dropdown.open{display:block}
  .tag-option{padding:8px 14px;font-size:13px;cursor:pointer;color:var(--text-secondary);transition:background var(--transition)}
  .tag-option:hover,.tag-option.highlighted{background:var(--bg-hover);color:var(--text)}
  .tag-option.create-new{color:var(--accent);border-top:1px solid var(--border-subtle);font-weight:500}

  .capture-btn{font-family:var(--font);font-size:14px;font-weight:600;padding:10px 22px;background:linear-gradient(135deg,var(--accent),var(--accent-dim));color:#fff;border:none;border-radius:var(--radius);cursor:pointer;transition:all var(--transition);white-space:nowrap;height:40px;box-shadow:0 2px 8px rgba(196,149,106,.2)}
  .capture-btn:hover{transform:translateY(-1px);box-shadow:0 4px 14px rgba(196,149,106,.3)}
  .capture-btn:active{transform:translateY(0)}
  .capture-hint{margin-top:16px;font-size:11px;color:var(--text-muted);font-family:var(--mono)}
  .capture-hint kbd{background:var(--bg-surface);padding:2px 6px;border-radius:4px;border:1px solid var(--border-subtle);font-size:10px;box-shadow:0 1px 0 var(--border)}

  .date-override-row{width:100%;display:flex;align-items:center;gap:8px;margin-top:8px}
  .date-override-label{font-size:12px;color:var(--text-muted);white-space:nowrap}
  .date-override-input{font-family:var(--font);font-size:13px;padding:5px 10px;background:var(--bg-surface);border:1px solid var(--border-subtle);border-radius:var(--radius);color:var(--text);outline:none;transition:all var(--transition)}
  .date-override-input:focus{border-color:var(--accent);box-shadow:0 0 0 2px var(--accent-glow)}
  .date-now-btn{cursor:pointer;text-decoration:underline;border:none;background:none;font-family:var(--font);font-size:12px;color:var(--accent)}

  /* FLASH & UNDO */
  .capture-flash{position:fixed;top:20px;left:50%;transform:translateX(-50%) translateY(-60px);background:var(--bg-surface);border:1px solid var(--accent);color:var(--accent);padding:10px 24px;border-radius:var(--radius);font-size:14px;font-weight:500;opacity:0;transition:all 300ms ease;z-index:200;pointer-events:none;box-shadow:var(--shadow-md)}
  .capture-flash.show{opacity:1;transform:translateX(-50%) translateY(0)}
  .undo-toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%) translateY(80px);background:var(--undo-bg);color:var(--undo-text);padding:12px 20px;border-radius:var(--radius);font-size:14px;display:flex;align-items:center;gap:14px;opacity:0;transition:all 300ms ease;z-index:200;box-shadow:0 8px 24px rgba(0,0,0,.2)}
  .undo-toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
  .undo-toast button{font-family:var(--font);font-size:13px;font-weight:600;padding:4px 14px;background:var(--accent);color:#fff;border:none;border-radius:5px;cursor:pointer;transition:opacity 150ms}
  .undo-toast button:hover{opacity:.85}
  .undo-toast .undo-dismiss{background:transparent;color:var(--undo-text);opacity:.5;padding:4px 8px;font-size:16px}

  /* REVIEW */
  .review-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;flex-wrap:wrap;gap:8px}
  .review-title{font-family:var(--font-display);font-size:22px;font-weight:400}
  .review-count{font-size:12px;color:var(--text-muted);font-family:var(--mono)}
  .review-empty{text-align:center;padding:80px 20px;color:var(--text-muted)}
  .review-empty-icon{font-size:36px;margin-bottom:14px;opacity:.35}
  .review-empty h3{font-family:var(--font-display);font-size:18px;font-weight:400;color:var(--text-secondary);margin-bottom:6px}
  .review-empty p{font-size:14px}

  .item-card{background:var(--bg-surface);border:1px solid var(--border-subtle);border-radius:var(--radius-lg);padding:18px 20px;margin-bottom:10px;transition:all var(--transition);animation:slideIn 250ms ease;box-shadow:var(--shadow-sm);position:relative}
  @keyframes slideIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
  .item-card:hover{border-color:var(--border);box-shadow:var(--shadow-md)}
  .item-card.pinned{border-left:3px solid var(--accent)}
  .item-card.review-focus{border-color:var(--accent);box-shadow:0 0 0 2px var(--accent-glow)}

  .item-text-edit{width:100%;font-family:var(--font);font-size:15px;line-height:1.6;margin-bottom:12px;background:transparent;border:none;resize:none;color:var(--text);padding:0;outline:none;min-height:24px;border-radius:4px;transition:background .2s;overflow:hidden}
  .item-text-edit:focus{background:var(--bg-hover);padding:4px;margin:-4px -4px 12px -4px}
  .item-text{font-size:15px;line-height:1.6;margin-bottom:12px;white-space:pre-wrap;word-break:break-word}
  .item-text .quote-mark{font-family:var(--font-display);font-style:italic;color:var(--cat-quote);opacity:.5}

  .item-footer{display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px}
  .item-meta{display:flex;align-items:center;gap:8px;flex-wrap:wrap;font-size:12px;color:var(--text-muted);font-family:var(--mono)}
  .item-tag{display:inline-flex;align-items:center;padding:2px 9px;background:var(--accent-glow);color:var(--accent);border-radius:20px;font-size:11px;font-weight:500;font-family:var(--font)}

  .cat-badge{font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.04em;padding:2px 8px;border-radius:4px;font-family:var(--font)}
  .cat-badge.quote{background:var(--cat-quote-bg);color:var(--cat-quote)}
  .cat-badge.first{background:var(--cat-first-bg);color:var(--cat-first)}
  .cat-badge.funny{background:var(--cat-funny-bg);color:var(--cat-funny)}
  .cat-badge.note{background:var(--cat-note-bg);color:var(--cat-note)}

  .item-actions{display:flex;gap:6px;flex-wrap:wrap}
  .item-action-btn{font-family:var(--font);font-size:12px;font-weight:500;padding:5px 12px;border:1px solid var(--border-subtle);background:transparent;border-radius:6px;cursor:pointer;transition:all var(--transition);-webkit-tap-highlight-color:transparent}
  .item-action-btn:active{transform:scale(.95)}
  .item-action-btn.pin-type{color:var(--accent);border-color:rgba(196,149,106,.3)}
  .item-action-btn.pin-type:hover{background:var(--accent-glow)}
  .item-action-btn.pin-type.is-pinned{background:var(--accent-glow);font-weight:600}
  .item-action-btn.delete-type{color:var(--danger);border-color:rgba(184,84,80,.2)}
  .item-action-btn.delete-type:hover{background:var(--danger-bg)}

  .review-cats{display:flex;gap:4px;flex-wrap:wrap}
  .review-cat-btn{font-family:var(--font);font-size:11px;font-weight:500;padding:4px 10px;border:1px solid var(--border-subtle);background:transparent;border-radius:4px;cursor:pointer;transition:all var(--transition);color:var(--text-muted)}
  .review-cat-btn:hover{color:var(--text-secondary)}
  .review-cat-btn.selected{font-weight:600}
  .review-cat-btn[data-cat="quote"].selected{color:var(--cat-quote);background:var(--cat-quote-bg);border-color:rgba(122,111,90,.3)}
  .review-cat-btn[data-cat="first"].selected{color:var(--cat-first);background:var(--cat-first-bg);border-color:rgba(196,149,106,.35)}
  .review-cat-btn[data-cat="funny"].selected{color:var(--cat-funny);background:var(--cat-funny-bg);border-color:rgba(184,137,76,.35)}
  .review-cat-btn[data-cat="note"].selected{color:var(--cat-note);background:var(--cat-note-bg);border-color:rgba(138,154,122,.3)}

  /* TIMELINE */
  .timeline-controls{display:flex;gap:10px;margin-bottom:14px;flex-wrap:wrap}
  .input-wrap{flex:1;min-width:160px;position:relative}
  .input-wrap input{width:100%;font-family:var(--font);font-size:14px;padding:9px 30px 9px 14px;background:var(--bg-surface);border:1px solid var(--border-subtle);border-radius:var(--radius);color:var(--text);outline:none;transition:all var(--transition);box-shadow:var(--shadow-sm)}
  .input-wrap input:focus{border-color:var(--accent);box-shadow:0 0 0 2px var(--accent-glow)}
  .input-wrap input::placeholder{color:var(--text-muted)}
  .input-clear{position:absolute;right:8px;top:50%;transform:translateY(-50%);width:20px;height:20px;border-radius:50%;border:none;background:var(--bg-hover);color:var(--text-muted);cursor:pointer;font-size:13px;display:none;align-items:center;justify-content:center;transition:all var(--transition);line-height:1}
  .input-clear:hover{background:var(--border);color:var(--text)}
  .input-wrap.has-value .input-clear{display:flex}

  .timeline-toolbar{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;flex-wrap:wrap;gap:8px}
  .cat-filters{display:flex;gap:5px;flex-wrap:wrap}
  .cat-filter-btn{font-family:var(--font);font-size:12px;font-weight:500;padding:5px 12px;border:1px solid var(--border-subtle);background:transparent;border-radius:20px;cursor:pointer;transition:all var(--transition);color:var(--text-muted)}
  .cat-filter-btn:hover{color:var(--text-secondary)}
  .cat-filter-btn.active-all{background:var(--bg-hover);color:var(--text);border-color:var(--border)}
  .cat-filter-btn.active-quote{background:var(--cat-quote-bg);color:var(--cat-quote);border-color:rgba(122,111,90,.3)}
  .cat-filter-btn.active-first{background:var(--cat-first-bg);color:var(--cat-first);border-color:rgba(196,149,106,.35)}
  .cat-filter-btn.active-funny{background:var(--cat-funny-bg);color:var(--cat-funny);border-color:rgba(184,137,76,.35)}
  .cat-filter-btn.active-note{background:var(--cat-note-bg);color:var(--cat-note);border-color:rgba(138,154,122,.3)}

  .sort-select{font-family:var(--font);font-size:12px;padding:4px 8px;border:1px solid var(--border-subtle);background:var(--bg-surface);border-radius:6px;color:var(--text-secondary);cursor:pointer;outline:none}
  .timeline-count{font-size:12px;color:var(--text-muted);font-family:var(--mono);margin-bottom:14px}
  .date-group-label{font-family:var(--font-display);font-size:13px;font-weight:400;color:var(--text-muted);padding:14px 0 6px;border-bottom:1px solid var(--border-subtle);margin-bottom:10px}
  .pin-indicator{color:var(--accent);font-size:12px;margin-right:2px}

  /* SETTINGS */
  .settings-bar{padding:16px 0;border-top:1px solid var(--border-subtle);display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px}
  .settings-left{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
  .settings-bar .subtle-btn{font-family:var(--mono);font-size:11px;padding:6px 12px;border:1px solid var(--border-subtle);background:transparent;color:var(--text-muted);border-radius:6px;cursor:pointer;transition:all var(--transition)}
  .settings-bar .subtle-btn:hover{border-color:var(--border);color:var(--text-secondary);background:var(--bg-hover)}
  .settings-bar .subtle-btn.danger:hover{border-color:rgba(184,84,80,.3);color:var(--danger);background:var(--danger-bg)}
  .stats-text{font-family:var(--mono);font-size:11px;color:var(--text-muted)}

  .sync-btn{display:inline-flex;align-items:center;gap:6px;font-family:var(--font);font-size:12px;font-weight:500;padding:6px 14px;border:1px solid var(--border-subtle);background:transparent;color:var(--text-secondary);border-radius:6px;cursor:pointer;transition:all var(--transition)}
  .sync-btn:hover{border-color:var(--border);color:var(--text);background:var(--bg-hover)}
  .sync-btn.syncing{color:var(--accent);border-color:rgba(196,149,106,.3)}
  .sync-btn.synced{color:var(--cat-note);border-color:rgba(138,154,122,.3)}
  .sync-btn.sync-error{color:var(--danger);border-color:rgba(184,84,80,.3)}
  .sync-dot{width:8px;height:8px;border-radius:50%;background:var(--border);display:inline-block;flex-shrink:0}
  .sync-btn.syncing .sync-dot{background:var(--accent);animation:pulse 1s infinite}
  .sync-btn.synced .sync-dot{background:var(--cat-note)}
  .sync-btn.sync-error .sync-dot{background:var(--danger)}
  @keyframes pulse{0%{opacity:1}50%{opacity:.4}100%{opacity:1}}

  /* MODAL */
  .modal-overlay{position:fixed;inset:0;background:var(--modal-overlay);backdrop-filter:blur(6px);z-index:500;display:none;align-items:center;justify-content:center;padding:20px}
  .modal-overlay.open{display:flex}
  .modal{background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius-lg);padding:28px;max-width:460px;width:100%;box-shadow:var(--shadow-lg)}
  .modal h3{font-family:var(--font-display);font-size:18px;font-weight:400;margin-bottom:12px}
  .modal p{font-size:14px;color:var(--text-secondary);margin-bottom:16px;line-height:1.6}
  .modal-input{width:100%;padding:10px 14px;margin-bottom:16px;border:1px solid var(--border);border-radius:var(--radius);font-family:var(--font);font-size:14px;color:var(--text);background:var(--bg-surface);outline:none}
  .modal-input:focus{border-color:var(--accent);box-shadow:0 0 0 2px var(--accent-glow)}
  .modal-actions{display:flex;gap:10px;justify-content:flex-end}
  .modal-btn{font-family:var(--font);font-size:13px;font-weight:500;padding:8px 20px;border-radius:var(--radius);cursor:pointer;transition:all var(--transition);border:1px solid var(--border);background:transparent;color:var(--text-secondary)}
  .modal-btn:hover{color:var(--text);background:var(--bg-hover)}
  .modal-btn.primary{background:var(--accent);border-color:var(--accent);color:#fff}
  .modal-btn.primary:hover{opacity:.9}
  .modal-btn.confirm-danger{background:var(--danger);border-color:var(--danger);color:#fff}

  /* RESPONSIVE */
  @media(max-width:600px){.app{padding:0 14px}header{padding:20px 0 16px;flex-wrap:wrap;gap:12px}.capture-input{font-size:16px;padding:16px 18px}.capture-meta{flex-direction:column}.capture-btn{width:100%;text-align:center}nav button{padding:7px 12px;font-size:12px}.timeline-controls{flex-direction:column}.item-footer{flex-direction:column;align-items:flex-start}.item-action-btn{padding:8px 16px;font-size:13px}.settings-bar{flex-direction:column;align-items:flex-start}}
  ::-webkit-scrollbar{width:6px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}::-webkit-scrollbar-thumb:hover{background:var(--text-muted)}
  .hidden{display:none!important}
</style>
</head>
<body data-theme="light">
<div class="app">
  <header>
    <div class="header-left">
      <div class="logo"><div class="logo-mark">p</div><div class="logo-text">pocketpip</div></div>
      <div class="child-selector" id="child-selector">
        <button class="child-active-btn" id="child-active-btn"><span id="child-active-name">Malcolm</span><span class="child-arrow">&#9662;</span></button>
        <div class="child-dropdown" id="child-dropdown"></div>
      </div>
    </div>
    <div class="header-right">
      <button class="theme-toggle" id="theme-toggle" title="Toggle dark mode">&#9788;</button>
      <nav id="nav">
        <button class="active" data-view="capture">Capture</button>
        <button data-view="review">Review <span class="badge hidden" id="review-badge">0</span></button>
        <button data-view="timeline">Timeline</button>
      </nav>
    </div>
  </header>
  <main>
    <section id="view-capture" class="capture-view">
      <div class="capture-prompt" id="capture-prompt">what just happened?</div>
      <div class="capture-input-wrap">
        <textarea class="capture-input" id="capture-input" placeholder="A moment worth remembering..." rows="2"></textarea>
        <div class="capture-char-count" id="char-count">0</div>
      </div>
      <div class="category-bar" id="category-bar">
        <button class="cat-chip" data-cat="quote">Quote</button>
        <button class="cat-chip" data-cat="first">First</button>
        <button class="cat-chip" data-cat="funny">Funny</button>
        <button class="cat-chip" data-cat="note">Note</button>
      </div>
      <div class="capture-meta">
        <div class="tag-container" id="tag-container">
          <input type="text" class="tag-select-input" id="tag-input" placeholder="Tags..." autocomplete="off">
          <div class="tag-dropdown" id="tag-dropdown"></div>
        </div>
        <button class="capture-btn" id="capture-btn">Capture</button>
      </div>
      <div class="date-override-row">
        <span class="date-override-label">When:</span>
        <input type="datetime-local" class="date-override-input" id="date-override">
        <button class="date-now-btn" id="date-now-btn">now</button>
      </div>
      <div class="capture-hint"><kbd>Ctrl</kbd>+<kbd>Enter</kbd> capture &middot; <kbd>/</kbd> focus</div>
    </section>
    <section id="view-review" class="hidden">
      <div class="review-header"><h2 class="review-title">Review</h2><span class="review-count" id="review-count"></span></div>
      <div id="review-list"></div>
    </section>
    <section id="view-timeline" class="hidden">
      <div class="timeline-controls">
        <div class="input-wrap" id="search-wrap"><input type="text" id="search-input" placeholder="Search moments..."><button class="input-clear" id="search-clear">&times;</button></div>
        <div class="input-wrap" id="filter-wrap"><input type="text" id="filter-tag-input" placeholder="Filter by tag..." autocomplete="off"><button class="input-clear" id="filter-clear">&times;</button><div class="tag-dropdown" id="filter-tag-dropdown"></div></div>
      </div>
      <div class="timeline-toolbar">
        <div class="cat-filters" id="cat-filters">
          <button class="cat-filter-btn active-all" data-cat="all">All</button>
          <button class="cat-filter-btn" data-cat="quote">Quotes</button>
          <button class="cat-filter-btn" data-cat="first">Firsts</button>
          <button class="cat-filter-btn" data-cat="funny">Funny</button>
          <button class="cat-filter-btn" data-cat="note">Notes</button>
          <button class="cat-filter-btn" data-cat="uncategorised">Inbox</button>
        </div>
        <select class="sort-select" id="sort-select"><option value="newest">Newest</option><option value="oldest">Oldest</option></select>
      </div>
      <div class="timeline-count" id="timeline-count"></div>
      <div id="timeline-list"></div>
    </section>
  </main>
  <div class="settings-bar">
    <div class="settings-left">
      <button class="sync-btn" id="manual-sync-btn" title="Sync now"><span id="sync-indicator" class="sync-dot"></span><span id="sync-label">Sync</span></button>
      <span class="stats-text" id="stats-text"></span>
    </div>
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <button class="subtle-btn" id="cloud-btn">Sync Settings</button>
      <button class="subtle-btn" id="purge-btn" style="display:none">Empty Trash</button>
      <button class="subtle-btn" id="export-btn">Export</button>
      <button class="subtle-btn" id="import-btn">Import</button>
      <button class="subtle-btn danger" id="clear-btn">Clear All</button>
    </div>
  </div>
</div>
<div class="capture-flash" id="capture-flash">&#10003; Captured</div>
<div class="undo-toast" id="undo-toast"><span id="undo-text">Moment removed</span><button id="undo-btn">Undo</button><button class="undo-dismiss" id="undo-dismiss">&times;</button></div>
<div class="modal-overlay" id="modal-overlay"><div class="modal"><h3 id="modal-title">Confirm</h3><p id="modal-body">Are you sure?</p><div id="modal-content"></div><div class="modal-actions"><button class="modal-btn" id="modal-cancel">Cancel</button><button class="modal-btn primary" id="modal-confirm">Confirm</button></div></div></div>
<input type="file" id="import-file" accept=".json" style="display:none">
<script>
const STORAGE_KEY = 'pocketpip_data',
      CLOUD_URL_KEY = 'pocketpip_cloud_url',
      THEME_KEY = 'pocketpip_theme',
      ACTIVE_CHILD_KEY = 'pocketpip_active_child',
      CATEGORIES = ['quote','first','funny','note'];

function loadData(){try{const raw=localStorage.getItem(STORAGE_KEY);if(raw){const d=JSON.parse(raw);if(!Array.isArray(d.items))d.items=[];if(!Array.isArray(d.tags))d.tags=[];if(!Array.isArray(d.children))d.children=['Malcolm'];d.items=d.items.filter(i=>i&&typeof i.id==='string'&&typeof i.text==='string');d.items.forEach(i=>{if(!Array.isArray(i.tags))i.tags=i.tag?[i.tag]:[];if(!i.category)i.category='';if(!i.createdAt)i.createdAt=new Date().toISOString();if(typeof i.pinned==='undefined')i.pinned=false;if(!i.childName)i.childName=d.children[0]||'Malcolm';delete i.tag});const P=30*24*60*60*1000;d.items=d.items.filter(i=>{if(!i._deleted)return true;if(!i._deletedAt)return false;return(Date.now()-new Date(i._deletedAt).getTime())<P});return d}}catch(e){console.error('Load error:',e)}return{children:['Malcolm'],tags:[],items:[]}}

let _ss=false;function saveData(d){localStorage.setItem(STORAGE_KEY,JSON.stringify(d));if(!_ss)triggerCloudSync(d)}
let data=loadData();
let activeChild=localStorage.getItem(ACTIVE_CHILD_KEY)||data.children[0]||'Malcolm';
if(!data.children.includes(activeChild)){activeChild=data.children[0]||'Malcolm';if(!data.children.includes(activeChild))data.children.push(activeChild)}

// CHILD MANAGEMENT
function setActiveChild(name){activeChild=name;localStorage.setItem(ACTIVE_CHILD_KEY,name);document.getElementById('child-active-name').textContent=name;document.title='pocketpip \u2014 '+name;document.getElementById('capture-prompt').textContent='what did '+name+' just do?';renderChildDropdown();renderCurrentView()}

function addChild(name){const c=name.trim();if(!c)return false;if(data.children.some(x=>x.toLowerCase()===c.toLowerCase()))return false;data.children.push(c);data.children.sort((a,b)=>a.toLowerCase().localeCompare(b.toLowerCase()));saveData(data);setActiveChild(c);return true}

function removeChild(name){if(data.children.length<=1)return;data.children=data.children.filter(c=>c!==name);data.items.forEach(i=>{if(i.childName===name&&!i._deleted){i._deleted=true;i._deletedAt=new Date().toISOString()}});saveData(data);if(activeChild===name)setActiveChild(data.children[0]);else renderChildDropdown()}

function renderChildDropdown(){const dd=document.getElementById('child-dropdown');let h='';data.children.forEach(name=>{const act=name===activeChild;h+='<div class="child-option '+(act?'active':'')+'" data-name="'+ea(name)+'">'+eh(name)+(data.children.length>1?'<span class="child-remove" data-name="'+ea(name)+'" title="Remove">&times;</span>':'')+'</div>'});h+='<div class="child-add-option" id="child-add-option">+ Add child</div>';dd.innerHTML=h;
dd.querySelectorAll('.child-option').forEach(o=>{o.addEventListener('click',e=>{if(e.target.classList.contains('child-remove'))return;setActiveChild(o.dataset.name);dd.classList.remove('open')})});
dd.querySelectorAll('.child-remove').forEach(b=>{b.addEventListener('click',e=>{e.stopPropagation();const n=b.dataset.name;modal.open('Remove '+n+'?','This will remove '+n+' and soft-delete all their moments. Recoverable from trash for 30 days.',null,()=>removeChild(n),'Remove',true)})});
document.getElementById('child-add-option').addEventListener('click',()=>{dd.classList.remove('open');modal.open('Add a child','Enter their name.',ct=>{const inp=document.createElement('input');inp.type='text';inp.className='modal-input';inp.id='new-child-input';inp.placeholder='Name';inp.addEventListener('keydown',e=>{if(e.key==='Enter'){e.preventDefault();modal.confirm.click()}});ct.appendChild(inp)},()=>{const n=document.getElementById('new-child-input').value.trim();if(n){if(!addChild(n))showFlash('Name exists');else showFlash(n+' added')}},'Add')})}

document.getElementById('child-active-btn').addEventListener('click',e=>{e.stopPropagation();document.getElementById('child-dropdown').classList.toggle('open')});
document.addEventListener('click',e=>{if(!e.target.closest('.child-selector'))document.getElementById('child-dropdown').classList.remove('open')});

// CLOUD SYNC
let cloudUrl=localStorage.getItem(CLOUD_URL_KEY)||'';const syncBtn=document.getElementById('manual-sync-btn'),syncLabel=document.getElementById('sync-label');let syncTimeout=null,lastSyncTime=null;
function setSyncStatus(s,t){syncBtn.className='sync-btn';if(s==='loading'){syncBtn.classList.add('syncing');syncLabel.textContent='Syncing...'}else if(s==='ok'){syncBtn.classList.add('synced');syncLabel.textContent=t||'Synced'}else if(s==='error'){syncBtn.classList.add('sync-error');syncLabel.textContent=t||'Error'}else{syncLabel.textContent=cloudUrl?'Sync':'Offline'}syncBtn.title=t||s||'Click to sync'}
syncBtn.addEventListener('click',()=>{if(cloudUrl&&validateCloudUrl(cloudUrl))fetchCloudData();else document.getElementById('cloud-btn').click()});
function validateCloudUrl(u){if(!u)return false;try{const x=new URL(u);return x.hostname==='script.google.com'&&x.pathname.startsWith('/macros/s/')}catch{return false}}
function validateCloudData(d){if(!d||typeof d!=='object')return false;if(!Array.isArray(d.items))return false;return d.items.every(i=>i&&typeof i.id==='string'&&typeof i.text==='string')}
function sanitizeCloudItem(item,ch){return{id:String(item.id).slice(0,50),text:String(item.text).slice(0,10000),tags:Array.isArray(item.tags)?item.tags.map(t=>String(t).slice(0,100)).slice(0,20):[],category:CATEGORIES.includes(item.category)?item.category:'',childName:typeof item.childName==='string'?item.childName.slice(0,100):(ch[0]||'Unknown'),createdAt:item.createdAt||new Date().toISOString(),updatedAt:item.updatedAt||null,pinned:!!item.pinned,_deleted:!!item._deleted,_deletedAt:item._deletedAt||null}}

function fetchCloudData(){if(!cloudUrl||!validateCloudUrl(cloudUrl))return;setSyncStatus('loading','Pulling...');fetch(cloudUrl,{method:'GET',redirect:'follow'}).then(r=>{if(!r.ok)throw new Error('HTTP '+r.status);return r.json()}).then(cd=>{if(cd.error){setSyncStatus('error','Server: '+cd.error);return}if(!validateCloudData(cd)){setSyncStatus('error','Invalid data');return}const cc=Array.isArray(cd.children)?cd.children:['Malcolm'];const si=cd.items.map(i=>sanitizeCloudItem(i,cc));const cm=new Map(si.map(i=>[i.id,i])),lm=new Map(data.items.map(i=>[i.id,i])),mm=new Map();for(const[id,item]of cm){const l=lm.get(id);if(!l){mm.set(id,item);continue}if(item._deleted||l._deleted){const w=item._deleted?item:l;mm.set(id,{...w,_deleted:true,_deletedAt:w._deletedAt||new Date().toISOString()});continue}const ct=new Date(item.updatedAt||item.createdAt),lt=new Date(l.updatedAt||l.createdAt);mm.set(id,lt>ct?l:item)}for(const[id,item]of lm){if(!mm.has(id))mm.set(id,item)}_ss=true;data.items=Array.from(mm.values());data.items.sort((a,b)=>new Date(b.createdAt)-new Date(a.createdAt));cc.forEach(c=>{if(!data.children.includes(c))data.children.push(c)});data.children.sort((a,b)=>a.toLowerCase().localeCompare(b.toLowerCase()));if(Array.isArray(cd.tags)){cd.tags.forEach(t=>{const cl=String(t).slice(0,100);if(cl&&!data.tags.includes(cl))data.tags.push(cl)})}saveData(data);_ss=false;pushToCloud(data);renderChildDropdown();renderCurrentView();lastSyncTime=new Date();setSyncStatus('ok','Synced '+formatTime(lastSyncTime.toISOString()))}).catch(e=>{console.error('Sync error:',e);_ss=false;setSyncStatus('error','Pull failed')})}

function pushToCloud(d){if(!cloudUrl||!validateCloudUrl(cloudUrl))return Promise.resolve();return fetch(cloudUrl,{method:'POST',redirect:'follow',body:JSON.stringify(d)}).then(()=>{lastSyncTime=new Date();setSyncStatus('ok','Synced '+formatTime(lastSyncTime.toISOString()))}).catch(e=>{console.error('Push error:',e);setSyncStatus('error','Push failed')})}
function triggerCloudSync(d){if(!cloudUrl||!validateCloudUrl(cloudUrl))return;setSyncStatus('loading','Saving...');clearTimeout(syncTimeout);syncTimeout=setTimeout(()=>pushToCloud(d),1500)}
document.addEventListener('visibilitychange',()=>{if(!document.hidden&&cloudUrl)fetchCloudData()});
if(cloudUrl&&validateCloudUrl(cloudUrl)){setSyncStatus('loading','Connecting...');setTimeout(fetchCloudData,500)}else if(cloudUrl&&!validateCloudUrl(cloudUrl)){setSyncStatus('error','Invalid URL')}

// ITEM OPERATIONS
function addItem(text,category,tags,dateOverride){const item={id:Date.now().toString(36)+Math.random().toString(36).slice(2,6),text:text.trim(),category:category||'',tags:(tags||[]).map(t=>t.trim()).filter(Boolean),childName:activeChild,createdAt:dateOverride||new Date().toISOString(),updatedAt:new Date().toISOString(),pinned:false};data.items.unshift(item);data.items.sort((a,b)=>new Date(b.createdAt)-new Date(a.createdAt));item.tags.forEach(t=>{if(!data.tags.includes(t))data.tags.push(t)});data.tags.sort((a,b)=>a.toLowerCase().localeCompare(b.toLowerCase()));saveData(data);return item}
function updateItem(id,u){const item=data.items.find(i=>i.id===id);if(!item)return;Object.assign(item,u,{updatedAt:new Date().toISOString()});if(u.tags)u.tags.forEach(t=>{if(!data.tags.includes(t))data.tags.push(t)});saveData(data)}
function togglePin(id){const i=data.items.find(x=>x.id===id);if(i){i.pinned=!i.pinned;saveData(data)}}
function deleteItem(id){const i=data.items.find(x=>x.id===id);if(!i)return null;i._deleted=true;i._deletedAt=new Date().toISOString();saveData(data);return{...i,_deleted:false,_deletedAt:null}}
function restoreItem(item){if(!item)return;const ex=data.items.find(i=>i.id===item.id);if(ex){ex._deleted=false;ex._deletedAt=null}else{item._deleted=false;item._deletedAt=null;data.items.push(item)}data.items.sort((a,b)=>new Date(b.createdAt)-new Date(a.createdAt));saveData(data)}
function purgeAllDeleted(){data.items=data.items.filter(i=>!i._deleted);saveData(data)}
function getChildItems(){return data.items.filter(i=>i.childName===activeChild&&!i._deleted)}
function getUncategorised(){return data.items.filter(i=>i.childName===activeChild&&!i.category&&!i._deleted)}
function getActiveItems(){return data.items.filter(i=>!i._deleted)}
function searchItems(query,tag,cat,sort){let r=data.items.filter(i=>i.childName===activeChild&&!i._deleted);if(cat&&cat!=='all'){if(cat==='uncategorised')r=r.filter(i=>!i.category);else r=r.filter(i=>i.category===cat)}if(tag)r=r.filter(i=>Array.isArray(i.tags)&&i.tags.some(t=>t.toLowerCase()===tag.toLowerCase()));if(query){const q=query.toLowerCase();r=r.filter(i=>i.text.toLowerCase().includes(q)||(Array.isArray(i.tags)&&i.tags.some(t=>t.toLowerCase().includes(q))))}r.sort((a,b)=>{if(a.pinned&&!b.pinned)return-1;if(!a.pinned&&b.pinned)return 1;const da=new Date(a.createdAt),db=new Date(b.createdAt);return sort==='oldest'?da-db:db-da});return r}

// UNDO
let undoStack=[],undoTimer=null;const undoToast=document.getElementById('undo-toast'),undoText=document.getElementById('undo-text');
function pushUndo(label,item){undoStack=[{label,item}];undoText.textContent=label;undoToast.classList.add('show');clearTimeout(undoTimer);undoTimer=setTimeout(()=>{undoToast.classList.remove('show');undoStack=[]},6000)}
document.getElementById('undo-btn').addEventListener('click',()=>{if(!undoStack.length)return;restoreItem(undoStack.pop().item);undoToast.classList.remove('show');clearTimeout(undoTimer);renderCurrentView()});
document.getElementById('undo-dismiss').addEventListener('click',()=>{undoToast.classList.remove('show');clearTimeout(undoTimer);undoStack=[]});

// THEME
const themeToggle=document.getElementById('theme-toggle');let currentTheme=localStorage.getItem(THEME_KEY)||'light';applyTheme(currentTheme);
function applyTheme(t){currentTheme=t;document.body.setAttribute('data-theme',t);themeToggle.innerHTML=t==='dark'?'&#9790;':'&#9788;';localStorage.setItem(THEME_KEY,t)}
themeToggle.addEventListener('click',()=>applyTheme(currentTheme==='dark'?'light':'dark'));

// VIEWS
const views=['capture','review','timeline'];let currentView='capture';
function switchView(v){currentView=v;views.forEach(x=>document.getElementById('view-'+x).classList.toggle('hidden',x!==v));document.querySelectorAll('#nav button').forEach(b=>b.classList.toggle('active',b.dataset.view===v));if(v==='review')renderReview();if(v==='timeline')renderTimeline();if(v==='capture')document.getElementById('capture-input').focus();updateBadge();updateStats()}
document.querySelectorAll('#nav button').forEach(b=>b.addEventListener('click',()=>switchView(b.dataset.view)));

// CAPTURE
const captureInput=document.getElementById('capture-input'),tagInput=document.getElementById('tag-input'),tagContainer=document.getElementById('tag-container'),tagDropdown=document.getElementById('tag-dropdown'),captureFlash=document.getElementById('capture-flash'),charCount=document.getElementById('char-count'),dateOverride=document.getElementById('date-override');
let activeTags=[],selectedCategory='';
function setDateNow(){const n=new Date(),o=n.getTimezoneOffset(),l=new Date(n.getTime()-o*60000);dateOverride.value=l.toISOString().slice(0,16)}
setDateNow();document.getElementById('date-now-btn').addEventListener('click',setDateNow);
captureInput.addEventListener('input',()=>{captureInput.style.height='auto';captureInput.style.height=Math.max(72,captureInput.scrollHeight)+'px';charCount.textContent=captureInput.value.length});
document.querySelectorAll('#category-bar .cat-chip').forEach(chip=>{chip.addEventListener('click',()=>{const c=chip.dataset.cat;if(selectedCategory===c){selectedCategory='';chip.classList.remove('selected')}else{selectedCategory=c;document.querySelectorAll('#category-bar .cat-chip').forEach(x=>x.classList.remove('selected'));chip.classList.add('selected')}})});
function renderActiveTags(){tagContainer.querySelectorAll('.tag-chip').forEach(c=>c.remove());activeTags.forEach((t,i)=>{const chip=document.createElement('div');chip.className='tag-chip';chip.innerHTML=eh(t)+' <span class="tag-remove" data-index="'+i+'">&times;</span>';tagContainer.insertBefore(chip,tagInput)})}
tagContainer.addEventListener('click',e=>{if(e.target.classList.contains('tag-remove')){activeTags.splice(parseInt(e.target.dataset.index),1);renderActiveTags()}else if(e.target===tagContainer)tagInput.focus()});
function addActiveTag(s){const c=s.trim();if(c&&!activeTags.includes(c)){activeTags.push(c);renderActiveTags()}tagInput.value=''}
function doCapture(){const text=captureInput.value.trim();if(!text){captureInput.focus();return}if(tagInput.value.trim())addActiveTag(tagInput.value);let d=null;if(dateOverride.value)d=new Date(dateOverride.value).toISOString();addItem(text,selectedCategory,[...activeTags],d);captureInput.value='';captureInput.style.height='auto';charCount.textContent='0';activeTags=[];renderActiveTags();tagInput.value='';tagDropdown.classList.remove('open');selectedCategory='';document.querySelectorAll('#category-bar .cat-chip').forEach(c=>c.classList.remove('selected'));setDateNow();showFlash('Moment captured');captureInput.focus();updateBadge();updateStats()}
document.getElementById('capture-btn').addEventListener('click',doCapture);
captureInput.addEventListener('keydown',e=>{if(e.key==='Enter'&&(e.ctrlKey||e.metaKey)){e.preventDefault();doCapture()}});

// TAG AUTOCOMPLETE
function setupTagAutocomplete(input,dropdown,onSelect){let hl=-1;function render(){const v=input.value.toLowerCase(),m=data.tags.filter(t=>t.toLowerCase().includes(v));let h='';m.forEach((t,i)=>{h+='<div class="tag-option" data-tag="'+ea(t)+'" data-index="'+i+'">'+eh(t)+'</div>'});if(v&&!data.tags.some(t=>t.toLowerCase()===v)){h+='<div class="tag-option create-new" data-tag="'+ea(input.value.trim())+'" data-index="'+m.length+'">+ Create "'+eh(input.value.trim())+'"</div>'}dropdown.innerHTML=h;hl=-1;if(h)dropdown.classList.add('open');else dropdown.classList.remove('open')}function sel(tag){if(onSelect)onSelect(tag);else input.value=tag;dropdown.classList.remove('open')}input.addEventListener('input',render);input.addEventListener('focus',render);input.addEventListener('keydown',e=>{const opts=dropdown.querySelectorAll('.tag-option');if(e.key==='Enter'){if(dropdown.classList.contains('open')&&hl>=0){e.preventDefault();sel(opts[hl].dataset.tag)}else if(input.value.trim()){e.preventDefault();if(onSelect)onSelect(input.value.trim())}}else if(e.key==='ArrowDown'){if(!dropdown.classList.contains('open'))return;e.preventDefault();hl=Math.min(hl+1,opts.length-1);opts.forEach((o,i)=>o.classList.toggle('highlighted',i===hl))}else if(e.key==='ArrowUp'){if(!dropdown.classList.contains('open'))return;e.preventDefault();hl=Math.max(hl-1,0);opts.forEach((o,i)=>o.classList.toggle('highlighted',i===hl))}else if(e.key==='Escape'){dropdown.classList.remove('open')}else if(e.key===','&&onSelect){e.preventDefault();if(input.value.trim())onSelect(input.value.trim())}});dropdown.addEventListener('click',e=>{const o=e.target.closest('.tag-option');if(o)sel(o.dataset.tag)});document.addEventListener('click',e=>{if(!input.contains(e.target)&&!dropdown.contains(e.target)&&!e.target.closest('.tag-container'))dropdown.classList.remove('open')})}
setupTagAutocomplete(tagInput,tagDropdown,tag=>addActiveTag(tag));
const filterTagInput=document.getElementById('filter-tag-input'),filterTagDropdown=document.getElementById('filter-tag-dropdown');
setupTagAutocomplete(filterTagInput,filterTagDropdown,tag=>{filterTagInput.value=tag;filterTagDropdown.classList.remove('open');updateInputWrap('filter-wrap',tag);renderTimeline()});
filterTagInput.addEventListener('input',()=>{updateInputWrap('filter-wrap',filterTagInput.value);if(!filterTagInput.value)renderTimeline()});
document.getElementById('search-clear').addEventListener('click',()=>{document.getElementById('search-input').value='';updateInputWrap('search-wrap','');renderTimeline()});
document.getElementById('filter-clear').addEventListener('click',()=>{filterTagInput.value='';updateInputWrap('filter-wrap','');renderTimeline()});
function updateInputWrap(id,v){document.getElementById(id).classList.toggle('has-value',!!v)}
document.getElementById('search-input').addEventListener('input',function(){updateInputWrap('search-wrap',this.value);renderTimeline()});

// REVIEW
let reviewFocusIdx=-1;
function renderReview(){const list=document.getElementById('review-list'),items=getUncategorised();document.getElementById('review-count').textContent=items.length+' uncategorised';reviewFocusIdx=-1;if(!items.length){list.innerHTML='<div class="review-empty"><div class="review-empty-icon">&#9826;</div><h3>All caught up</h3><p>No moments to review for '+eh(activeChild)+'. Go capture some.</p></div>';return}
list.innerHTML=items.map((item,idx)=>'<div class="item-card" data-id="'+ea(item.id)+'" data-review-idx="'+idx+'"><textarea class="item-text-edit" data-id="'+ea(item.id)+'">'+et(item.text)+'</textarea><div class="item-footer"><div class="item-meta">'+(item.tags||[]).map(t=>'<span class="item-tag">'+eh(t)+'</span>').join('')+'<span>'+formatTime(item.createdAt)+'</span></div><div class="item-actions"><div class="review-cats">'+CATEGORIES.map(c=>'<button class="review-cat-btn '+(item.category===c?'selected':'')+'" data-cat="'+c+'" data-id="'+ea(item.id)+'">'+c.charAt(0).toUpperCase()+c.slice(1)+'</button>').join('')+'</div><button class="item-action-btn delete-type" data-action="delete" data-id="'+ea(item.id)+'">Remove</button></div></div></div>').join('');
list.querySelectorAll('.review-cat-btn').forEach(b=>{b.addEventListener('click',()=>{updateItem(b.dataset.id,{category:b.dataset.cat});renderReview();updateBadge();updateStats()})});
list.querySelectorAll('.item-action-btn.delete-type').forEach(b=>{b.addEventListener('click',()=>{const rm=deleteItem(b.dataset.id);if(rm)pushUndo('Moment removed',rm);renderReview();updateBadge();updateStats()})});
list.querySelectorAll('textarea.item-text-edit').forEach(a=>{autoSize(a);a.addEventListener('input',()=>autoSize(a));a.addEventListener('blur',()=>{const item=data.items.find(i=>i.id===a.dataset.id);if(item&&item.text!==a.value)updateItem(a.dataset.id,{text:a.value.trim()})})})}
function autoSize(el){el.style.height='auto';el.style.height=el.scrollHeight+'px'}

// TIMELINE
let activeCat='all';
document.querySelectorAll('#cat-filters .cat-filter-btn').forEach(b=>{b.addEventListener('click',()=>{activeCat=b.dataset.cat;document.querySelectorAll('#cat-filters .cat-filter-btn').forEach(x=>x.className='cat-filter-btn');const m={all:'active-all',quote:'active-quote',first:'active-first',funny:'active-funny',note:'active-note',uncategorised:'active-all'};b.classList.add(m[activeCat]||'active-all');renderTimeline()})});
document.getElementById('sort-select').addEventListener('change',()=>renderTimeline());

function renderTimeline(){const query=document.getElementById('search-input').value,tag=filterTagInput.value,sort=document.getElementById('sort-select').value,results=searchItems(query,tag,activeCat,sort),list=document.getElementById('timeline-list');document.getElementById('timeline-count').textContent=results.length+' moment'+(results.length!==1?'s':'');
if(!results.length){list.innerHTML='<div class="review-empty"><div class="review-empty-icon">&#9826;</div><h3>No moments yet</h3><p>Capture something for '+eh(activeChild)+' and it will appear here.</p></div>';return}
const groups=groupByDate(results);let h='';for(const[label,items]of groups){h+='<div class="date-group-label">'+eh(label)+'</div>';h+=items.map(item=>{const cc=item.category||'',cl=item.category?item.category.charAt(0).toUpperCase()+item.category.slice(1):'Uncategorised',isQ=item.category==='quote',dt=isQ?'<span class="quote-mark">&ldquo;</span>'+eh(item.text)+'<span class="quote-mark">&rdquo;</span>':eh(item.text);return'<div class="item-card retrieve-item '+(item.pinned?'pinned':'')+'" data-id="'+ea(item.id)+'"><div class="item-text">'+(item.pinned?'<span class="pin-indicator">&#9873;</span> ':'')+dt+'</div><div class="item-footer"><div class="item-meta"><span class="cat-badge '+cc+'">'+cl+'</span>'+(item.tags||[]).map(t=>'<span class="item-tag">'+eh(t)+'</span>').join('')+'<span>'+formatTime(item.createdAt)+'</span></div><div class="item-actions"><button class="item-action-btn pin-type '+(item.pinned?'is-pinned':'')+'" data-action="pin" data-id="'+ea(item.id)+'">'+(item.pinned?'Unpin':'Pin')+'</button><button class="item-action-btn delete-type" data-action="delete" data-id="'+ea(item.id)+'">Delete</button></div></div></div>'}).join('')}list.innerHTML=h;
list.querySelectorAll('.item-action-btn').forEach(b=>{b.addEventListener('click',()=>{const id=b.dataset.id,a=b.dataset.action;if(a==='delete'){const rm=deleteItem(id);if(rm)pushUndo('Moment deleted',rm)}else if(a==='pin')togglePin(id);renderTimeline();updateBadge();updateStats()})})}

function groupByDate(items){const g=new Map(),now=new Date(),today=new Date(now.getFullYear(),now.getMonth(),now.getDate()),yesterday=new Date(today);yesterday.setDate(today.getDate()-1);const weekAgo=new Date(today);weekAgo.setDate(today.getDate()-7);items.forEach(item=>{const d=new Date(item.createdAt);let l;if(d>=today)l='Today';else if(d>=yesterday)l='Yesterday';else if(d>=weekAgo)l='This Week';else l=d.toLocaleDateString('en-GB',{month:'long',year:'numeric'});if(!g.has(l))g.set(l,[]);g.get(l).push(item)});return g}

// BADGE & STATS
function updateBadge(){const c=getUncategorised().length,b=document.getElementById('review-badge');b.textContent=c;b.classList.toggle('hidden',c===0)}
function updateStats(){const ci=getChildItems(),t=ci.length,q=ci.filter(i=>i.category==='quote').length,f=ci.filter(i=>i.category==='first').length,fu=ci.filter(i=>i.category==='funny').length,inbox=getUncategorised().length,all=getActiveItems().length,del=data.items.filter(i=>i._deleted).length;let s=t+' moments';if(data.children.length>1)s+=' ('+all+' total)';if(q)s+=' \xb7 '+q+' quotes';if(f)s+=' \xb7 '+f+' firsts';if(fu)s+=' \xb7 '+fu+' funny';if(inbox)s+=' \xb7 '+inbox+' inbox';if(del>0)s+=' \xb7 '+del+' trash';document.getElementById('stats-text').textContent=s;document.getElementById('purge-btn').style.display=del>0?'':'none'}

// MODAL
let modalCallback=null;const modal={overlay:document.getElementById('modal-overlay'),title:document.getElementById('modal-title'),body:document.getElementById('modal-body'),content:document.getElementById('modal-content'),cancel:document.getElementById('modal-cancel'),confirm:document.getElementById('modal-confirm'),open(t,b,cb,onC,ct,danger){modal.title.textContent=t;modal.body.textContent=b;modal.content.innerHTML='';if(cb)cb(modal.content);modal.confirm.textContent=ct||'Confirm';modal.confirm.className=danger?'modal-btn confirm-danger':'modal-btn primary';modal.overlay.classList.add('open');modalCallback=onC;const fi=modal.content.querySelector('input');if(fi)setTimeout(()=>fi.focus(),100)},close(){modal.overlay.classList.remove('open');modalCallback=null}};
modal.cancel.addEventListener('click',modal.close);modal.confirm.addEventListener('click',()=>{if(modalCallback)modalCallback();modal.close()});modal.overlay.addEventListener('click',e=>{if(e.target===modal.overlay)modal.close()});

// SETTINGS
document.getElementById('export-btn').addEventListener('click',()=>{const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'}),url=URL.createObjectURL(blob),a=document.createElement('a');a.href=url;a.download='pocketpip-'+new Date().toISOString().slice(0,10)+'.json';a.click();URL.revokeObjectURL(url)});
document.getElementById('import-btn').addEventListener('click',()=>document.getElementById('import-file').click());
document.getElementById('import-file').addEventListener('change',e=>{const file=e.target.files[0];if(!file)return;const reader=new FileReader();reader.onload=()=>{try{const imp=JSON.parse(reader.result);if(imp.items&&Array.isArray(imp.items)){const ids=new Set(data.items.map(i=>i.id));let c=0;imp.items.forEach(i=>{if(!ids.has(i.id)){if(!Array.isArray(i.tags))i.tags=i.tag?[i.tag]:[];if(!i.category)i.category='';if(!i.createdAt)i.createdAt=new Date().toISOString();if(!i.childName)i.childName=activeChild;i.pinned=!!i.pinned;delete i.tag;data.items.push(i);c++}});if(Array.isArray(imp.children))imp.children.forEach(ch=>{if(!data.children.includes(ch))data.children.push(ch)});if(imp.tags)imp.tags.forEach(t=>{if(!data.tags.includes(t))data.tags.push(t)});data.items.sort((a,b)=>new Date(b.createdAt)-new Date(a.createdAt));saveData(data);renderChildDropdown();renderCurrentView();showFlash('Imported '+c+' moments')}else throw new Error('Invalid')}catch(err){alert('Invalid file. Expected pocketpip JSON.')}};reader.readAsText(file);e.target.value=''});
document.getElementById('clear-btn').addEventListener('click',()=>{modal.open('Clear all data?','This permanently deletes all moments for all children.',null,()=>{data={children:['Malcolm'],tags:[],items:[]};saveData(data);activeChild='Malcolm';localStorage.setItem(ACTIVE_CHILD_KEY,activeChild);setActiveChild(activeChild);renderChildDropdown();renderCurrentView()},'Clear All',true)});
document.getElementById('purge-btn').addEventListener('click',()=>{const n=data.items.filter(i=>i._deleted).length;modal.open('Empty trash?','Permanently remove '+n+' deleted moment'+(n!==1?'s':'')+' across all children.',null,()=>{purgeAllDeleted();renderCurrentView();showFlash('Trash emptied')},'Empty Trash',true)});
document.getElementById('cloud-btn').addEventListener('click',()=>{modal.open('Sync Settings','Paste your Google Apps Script URL to sync between you and your partner.',ct=>{const inp=document.createElement('input');inp.type='text';inp.className='modal-input';inp.id='cloud-url-input';inp.placeholder='https://script.google.com/macros/s/...';inp.value=cloudUrl;ct.appendChild(inp);if(lastSyncTime){const p=document.createElement('p');p.style.cssText='font-size:12px;color:var(--text-muted)';p.textContent='Last synced: '+lastSyncTime.toLocaleString();ct.appendChild(p)}},()=>{const url=document.getElementById('cloud-url-input').value.trim();if(url&&validateCloudUrl(url)){localStorage.setItem(CLOUD_URL_KEY,url);cloudUrl=url;fetchCloudData()}else if(url){alert('Enter a valid Google Apps Script URL.')}else{localStorage.removeItem(CLOUD_URL_KEY);cloudUrl='';setSyncStatus('','Not connected')}},'Save')});

// HELPERS
function eh(s){if(typeof s!=='string')return'';const d=document.createElement('div');d.textContent=s;return d.innerHTML}
function ea(s){if(typeof s!=='string')return'';return s.replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/'/g,'&#39;').replace(/</g,'&lt;').replace(/>/g,'&gt;')}
function et(s){if(typeof s!=='string')return'';return s.replace(/</g,'&lt;').replace(/>/g,'&gt;')}
function formatTime(iso){const d=new Date(iso),now=new Date(),diff=now-d;if(diff<0)return d.toLocaleDateString('en-GB',{day:'numeric',month:'short',year:'numeric'});if(diff<60000)return'just now';if(diff<3600000)return Math.floor(diff/60000)+'m ago';if(diff<86400000)return Math.floor(diff/3600000)+'h ago';if(diff<172800000)return'yesterday';return d.toLocaleDateString('en-GB',{day:'numeric',month:'short'})}
function showFlash(t){captureFlash.textContent='\u2713 '+t;captureFlash.classList.add('show');setTimeout(()=>captureFlash.classList.remove('show'),1200)}
function renderCurrentView(){if(currentView==='review')renderReview();if(currentView==='timeline')renderTimeline();updateBadge();updateStats()}

// KEYBOARD SHORTCUTS
document.addEventListener('keydown',e=>{const tg=e.target.tagName,isI=tg==='INPUT'||tg==='TEXTAREA'||tg==='SELECT';if(e.key==='/'&&!isI){e.preventDefault();switchView('capture');captureInput.focus();return}if(e.key==='Escape'){if(modal.overlay.classList.contains('open')){modal.close();return}if(undoToast.classList.contains('show')){undoToast.classList.remove('show');return}document.getElementById('child-dropdown').classList.remove('open')}if(isI)return;if(e.key==='1')switchView('capture');if(e.key==='2')switchView('review');if(e.key==='3')switchView('timeline');
if(currentView==='review'){const cards=document.querySelectorAll('#review-list .item-card');if(!cards.length)return;if(e.key==='j'||e.key==='ArrowDown'){e.preventDefault();reviewFocusIdx=Math.min(reviewFocusIdx+1,cards.length-1);cards.forEach((c,i)=>c.classList.toggle('review-focus',i===reviewFocusIdx));cards[reviewFocusIdx].scrollIntoView({block:'nearest',behavior:'smooth'})}if(e.key==='k'||e.key==='ArrowUp'){e.preventDefault();reviewFocusIdx=Math.max(reviewFocusIdx-1,0);cards.forEach((c,i)=>c.classList.toggle('review-focus',i===reviewFocusIdx));cards[reviewFocusIdx].scrollIntoView({block:'nearest',behavior:'smooth'})}if(reviewFocusIdx>=0&&reviewFocusIdx<cards.length){const id=cards[reviewFocusIdx].dataset.id;if(e.key==='q'){updateItem(id,{category:'quote'});renderReview();updateBadge();updateStats()}if(e.key==='f'){updateItem(id,{category:'first'});renderReview();updateBadge();updateStats()}if(e.key==='u'){updateItem(id,{category:'funny'});renderReview();updateBadge();updateStats()}if(e.key==='n'){updateItem(id,{category:'note'});renderReview();updateBadge();updateStats()}if(e.key==='d'){const rm=deleteItem(id);if(rm)pushUndo('Moment removed',rm);renderReview();updateBadge();updateStats()}}}});

// INIT
setActiveChild(activeChild);renderChildDropdown();updateBadge();updateStats();captureInput.focus();
</script>
</body>
</html>
