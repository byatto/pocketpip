<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>pocketpip</title>
<link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' rx='20' fill='url(%23g)'/%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0' y1='0' x2='1' y2='1'%3E%3Cstop offset='0%25' stop-color='%237a8c5a'/%3E%3Cstop offset='100%25' stop-color='%2364744a'/%3E%3C/linearGradient%3E%3C/defs%3E%3Ctext x='50' y='70' font-family='Georgia,serif' font-size='56' font-weight='normal' font-style='italic' fill='white' fill-opacity='.95' text-anchor='middle'%3Ep%3C/text%3E%3C/svg%3E" type="image/svg+xml">
<link rel="manifest" href="manifest.json">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="theme-color" content="#f5f2ec">
<!-- Optimized Font Loading: Only loading Fraunces for personality. Body text uses System Fonts for speed. -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Fraunces:ital,opsz,wght@0,9..144,400;0,9..144,500;1,9..144,400&display=swap" rel="stylesheet">
<style>
  :root, [data-theme="light"] {
    --bg: #f5f2ec; --bg-surface: #ffffff; --bg-elevated: #ffffff; --bg-hover: #ede9e0; --bg-nav: #e8e3d9;
    --border: #d5cfc3; --border-subtle: #eae6de; 
    --text: #2a2925; --text-secondary: #5e5a4e; --text-muted: #9a9484;
    --accent: #7a8c5a; --accent-dim: #64744a; --accent-glow: rgba(122,140,90,.12);
    --cat-quote: #7a7260; --cat-quote-bg: rgba(122,114,96,.10);
    --cat-first: #7a8c5a; --cat-first-bg: rgba(122,140,90,.12);
    --cat-funny: #c49a3c; --cat-funny-bg: rgba(196,154,60,.12);
    --cat-note: #6e8898; --cat-note-bg: rgba(110,136,152,.10);
    --cat-neat: #9a7b5a; --cat-neat-bg: rgba(154,123,90,.10);
    --danger: #b85a52; --danger-bg: rgba(184,90,82,.08);
    --undo-bg: #33312a; --undo-text: #f5f2ec; --modal-overlay: rgba(245,242,236,.85);
    --shadow-sm: 0 1px 2px rgba(0,0,0,.04); --shadow-md: 0 4px 12px rgba(0,0,0,.06);
    --nav-height: 60px;
  }
  [data-theme="dark"] {
    --bg: #111111; --bg-surface: #1c1c1e; --bg-elevated: #2c2c2e; --bg-hover: #2c2c2e; --bg-nav: #1c1c1e;
    --border: #2c2c2e; --border-subtle: #242426; 
    --text: #e6e3d9; --text-secondary: #a8a494; --text-muted: #666;
    --accent: #97ad72; --accent-dim: #7e9460; --accent-glow: rgba(151,173,114,.12);
    --cat-quote: #b0a890; --cat-quote-bg: rgba(176,168,144,.12);
    --cat-first: #97ad72; --cat-first-bg: rgba(151,173,114,.14);
    --cat-funny: #d4b462; --cat-funny-bg: rgba(212,180,98,.14);
    --cat-note: #8aa4b6; --cat-note-bg: rgba(138,164,182,.12);
    --cat-neat: #c4a67a; --cat-neat-bg: rgba(196,166,122,.12);
    --danger: #cc6e66; --danger-bg: rgba(204,110,102,.10);
    --undo-bg: #e6e3d9; --undo-text: #1a1916; --modal-overlay: rgba(0,0,0,.85);
    --shadow-sm: 0 1px 3px rgba(0,0,0,.3); --shadow-md: 0 4px 16px rgba(0,0,0,.4);
  }
  :root {
    --radius: 12px; --radius-lg: 20px; --transition: 200ms cubic-bezier(0.2, 0.8, 0.2, 1); 
    /* System font stack for immediate loading and native feel */
    --font: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    --font-display: 'Fraunces', Georgia, serif; 
    --mono: 'SF Mono', 'Menlo', 'Monaco', 'Courier New', monospace;
  }
  *{margin:0;padding:0;box-sizing:border-box}
  body{font-family:var(--font);background:var(--bg);color:var(--text);min-height:100vh;line-height:1.5;-webkit-font-smoothing:antialiased;transition:background 300ms ease,color 300ms ease; padding-bottom: calc(var(--nav-height) + 20px);}
  .app{max-width:680px;margin:0 auto;padding:0 20px;display:flex;flex-direction:column}

  /* HEADER */
  header{padding:20px 0 10px;display:flex;align-items:center;justify-content:space-between; position:sticky; top:0; background:var(--bg); z-index:100;}
  .header-left{display:flex;align-items:center;gap:12px}
  .logo{display:flex;align-items:center;gap:8px;cursor:default}
  .logo-mark {width:32px;height:32px;border-radius:10px;background:linear-gradient(135deg, var(--accent), var(--accent-dim));display:flex;align-items:center;justify-content:center;font-family:var(--font-display);font-style:italic;font-size:18px;color:#fff;box-shadow:0 2px 8px var(--accent-glow);}
  .logo-text{font-family:var(--font-display);font-size:20px;font-weight:600;letter-spacing:-0.5px;color:var(--text)}

  /* CHILD SELECTOR */
  .child-selector{position:relative;display:inline-flex;align-items:center}
  .child-active-btn{display:inline-flex;align-items:center;gap:4px;font-family:var(--font);font-size:13px;font-weight:600;color:var(--text);background:var(--bg-hover);border-radius:100px;padding:6px 12px;cursor:pointer;transition:all var(--transition);white-space:nowrap; border:none;}
  .child-active-btn:hover{background:var(--border-subtle);}
  .child-arrow{font-size:8px;opacity:.5;margin-left:2px}
  .child-dropdown{position:absolute;top:calc(100% + 8px);left:0;min-width:180px;background:var(--bg-surface);border:1px solid var(--border-subtle);border-radius:var(--radius);box-shadow:var(--shadow-lg);z-index:300;display:none;overflow:hidden; animation: slideDown 0.1s ease-out;}
  @keyframes slideDown { from{opacity:0;transform:translateY(-5px)} to{opacity:1;transform:translateY(0)} }
  .child-dropdown.open{display:block}
  .child-option{padding:12px 16px;font-size:14px;cursor:pointer;color:var(--text);transition:background var(--transition);display:flex;align-items:center;justify-content:space-between; border-bottom: 1px solid var(--border-subtle);}
  .child-option:last-child{border-bottom:none;}
  .child-option:hover{background:var(--bg-hover);}
  .child-option.active{color:var(--accent);font-weight:600;background:var(--bg-hover);}
  .child-remove{opacity:.4;font-size:16px;color:var(--text);padding:4px;}
  .child-remove:hover{opacity:1;color:var(--danger);}
  .child-add-option{padding:12px 16px;font-size:13px;cursor:pointer;color:var(--accent);font-weight:600;background:var(--bg-surface);}
  
  .header-right{display:flex;align-items:center;gap:8px}
  .theme-toggle{width:36px;height:36px;border-radius:50%;border:none;background:var(--bg-hover);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:16px;transition:all var(--transition);color:var(--text-secondary)}
  .theme-toggle:hover{background:var(--border-subtle);color:var(--text)}

  /* DESKTOP NAV */
  nav.desktop-nav{display:flex;gap:4px;background:var(--bg-nav);padding:4px;border-radius:12px}
  nav.desktop-nav button{font-family:var(--font);font-size:13px;font-weight:500;padding:6px 14px;border:none;background:transparent;color:var(--text-secondary);border-radius:8px;cursor:pointer;transition:all var(--transition);position:relative}
  nav.desktop-nav button:hover{color:var(--text)}
  nav.desktop-nav button.active{background:var(--bg-surface);color:var(--text);font-weight:600;box-shadow:var(--shadow-sm)}
  .badge{position:absolute;top:-2px;right:-2px;background:var(--accent);color:#fff;font-size:10px;font-weight:700;min-width:16px;height:16px;border-radius:8px;display:flex;align-items:center;justify-content:center;padding:0 4px; box-shadow: 0 0 0 2px var(--bg-nav);}

  /* MOBILE NAV (Bottom Bar) */
  nav.mobile-nav {
    display: none; 
    position: fixed; bottom: 0; left: 0; right: 0; 
    background: var(--bg-surface); 
    border-top: 1px solid var(--border-subtle);
    padding: 8px 20px max(8px, env(safe-area-inset-bottom));
    justify-content: space-around;
    z-index: 400;
    box-shadow: 0 -4px 20px rgba(0,0,0,0.03);
  }
  nav.mobile-nav button {
    background: none; border: none; 
    display: flex; flex-direction: column; align-items: center; gap: 4px;
    color: var(--text-muted); font-size: 11px; font-weight: 500;
    width: 60px; padding: 4px 0;
    position: relative;
  }
  nav.mobile-nav button.active { color: var(--accent); }
  nav.mobile-nav button svg { width: 22px; height: 22px; fill: currentColor; }
  
  main{flex:1;padding:10px 0 20px;}

  /* CAPTURE */
  .capture-view{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:50vh; max-width: 600px; margin: 0 auto; width: 100%;}
  .capture-prompt{font-family:var(--font-display);font-style:italic;font-size:18px;color:var(--text-muted);margin-bottom:16px}
  .capture-input-wrap{width:100%;position:relative}
  .capture-input{width:100%;font-family:var(--font);font-size:20px;line-height:1.5;font-weight:400;padding:24px;background:var(--bg-surface);border:none;border-radius:var(--radius-lg);color:var(--text);outline:none;transition:all var(--transition);resize:none;min-height:120px;box-shadow:var(--shadow-md);}
  .capture-input::placeholder{color:var(--text-muted);font-weight:300}
  .capture-input:focus{box-shadow:0 0 0 2px var(--accent), var(--shadow-md);}
  .capture-char-count{position:absolute;bottom:12px;right:16px;font-family:var(--mono);font-size:10px;color:var(--text-muted);opacity:0;transition:opacity 200ms}
  .capture-input:focus~.capture-char-count{opacity:1}

  .category-bar{width:100%;display:flex;gap:8px;margin-top:20px;flex-wrap:wrap;justify-content:center;}
  .cat-chip{font-family:var(--font);font-size:14px;font-weight:500;padding:8px 18px;border:1px solid var(--border);background:transparent;border-radius:100px;cursor:pointer;transition:all var(--transition);color:var(--text-secondary);-webkit-tap-highlight-color:transparent}
  .cat-chip:hover{background:var(--bg-hover);}
  .cat-chip.selected{font-weight:600; border-color: transparent;}
  .cat-chip[data-cat="quote"].selected{color:var(--cat-quote);background:var(--cat-quote-bg);}
  .cat-chip[data-cat="first"].selected{color:var(--cat-first);background:var(--cat-first-bg);}
  .cat-chip[data-cat="funny"].selected{color:var(--cat-funny);background:var(--cat-funny-bg);}
  .cat-chip[data-cat="note"].selected{color:var(--cat-note);background:var(--cat-note-bg);}
  .cat-chip[data-cat="neat"].selected{color:var(--cat-neat);background:var(--cat-neat-bg);}

  .capture-meta{width:100%;display:flex;flex-direction:column; gap:16px;margin-top:20px;align-items:center}
  .tag-container{width:100%;position:relative;background:transparent;border-bottom:1px solid var(--border-subtle);display:flex;flex-wrap:wrap;align-items:center;gap:6px;padding:6px 0;transition:all var(--transition);}
  .tag-container:focus-within{border-color:var(--accent);}
  .tag-chip{display:inline-flex;align-items:center;gap:4px;background:var(--bg-elevated);border:1px solid var(--border-subtle);color:var(--text-secondary);font-size:12px;padding:4px 10px;border-radius:100px;}
  .tag-chip .tag-remove{cursor:pointer;opacity:.5;font-size:14px;margin-left:2px;line-height:1}
  .tag-chip .tag-remove:hover{opacity:1;color:var(--danger)}
  .tag-select-input{flex:1;min-width:70px;font-family:var(--font);font-size:14px;border:none;background:transparent;color:var(--text);outline:none;padding:8px 0}
  .tag-select-input::placeholder{color:var(--text-muted)}
  .tag-dropdown{position:absolute;top:100%;left:0;right:0;background:var(--bg-elevated);border:1px solid var(--border-subtle);border-radius:var(--radius);box-shadow:var(--shadow-lg);z-index:100;max-height:180px;overflow-y:auto;display:none}
  .tag-dropdown.open{display:block}
  .tag-option{padding:10px 14px;font-size:13px;cursor:pointer;color:var(--text);transition:background var(--transition)}
  .tag-option:hover,.tag-option.highlighted{background:var(--bg-hover);}
  
  .capture-btn{width: 100%; font-family:var(--font);font-size:16px;font-weight:600;padding:14px;background:var(--accent);color:#fff;border:none;border-radius:var(--radius);cursor:pointer;transition:all var(--transition);height:50px;box-shadow:0 4px 12px var(--accent-glow)}
  .capture-btn:active{transform:scale(0.98); opacity: 0.9;}

  .date-row{width:100%;display:flex;align-items:center;gap:12px;margin-top:8px; justify-content: flex-end;}
  .date-override-input{font-family:var(--font);font-size:12px;padding:4px 8px;background:transparent;border:1px solid transparent;border-radius:6px;color:var(--text-muted);outline:none;transition:all var(--transition); cursor: pointer;}
  .date-override-input:hover{background:var(--bg-hover); color: var(--text);}
  .date-override-input:focus{border-color:var(--border); color: var(--text);}
  .text-btn{cursor:pointer;border:none;background:none;font-family:var(--font);font-size:12px;color:var(--accent); padding: 4px 8px; border-radius: 6px;}
  .text-btn:hover {background: var(--accent-glow);}

  /* LISTS & REVIEWS */
  .review-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;flex-wrap:wrap;gap:8px}
  .review-title{font-family:var(--font-display);font-size:24px;font-weight:500; letter-spacing: -0.5px;}
  .review-empty{text-align:center;padding:60px 20px;color:var(--text-muted)}
  .review-empty-icon{font-size:48px;margin-bottom:16px;opacity:.2; filter: grayscale(100%);}

  .item-card{background:var(--bg-surface);border-radius:var(--radius);padding:16px;margin-bottom:12px;transition:all var(--transition);animation:slideIn 250ms ease;box-shadow:var(--shadow-sm);position:relative; border: 1px solid transparent;}
  @keyframes slideIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
  .item-card:hover{box-shadow:var(--shadow-md);}
  .item-card.review-focus{border-color:var(--accent);box-shadow:0 0 0 2px var(--accent-glow)}

  .item-text-edit{width:100%;font-family:var(--font);font-size:16px;line-height:1.5;margin-bottom:12px;background:transparent;border:none;resize:none;color:var(--text);padding:0;outline:none;min-height:24px;border-radius:4px;}
  .item-text{font-size:16px;line-height:1.5;margin-bottom:12px;white-space:pre-wrap;word-break:break-word}
  .item-text .quote-mark{font-family:var(--font-display);font-style:italic;color:var(--cat-quote);opacity:.5; margin: 0 2px;}

  .item-footer{display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px; margin-top: 8px;}
  .item-meta{display:flex;align-items:center;gap:8px;flex-wrap:wrap;font-size:12px;color:var(--text-muted);}
  .item-tag{color:var(--text-secondary);background:var(--bg-nav);padding:2px 8px; border-radius: 4px; font-size: 11px;}
  
  .cat-badge{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.05em;padding:3px 8px;border-radius:4px;}
  .cat-badge.quote{background:var(--cat-quote-bg);color:var(--cat-quote)}
  .cat-badge.first{background:var(--cat-first-bg);color:var(--cat-first)}
  .cat-badge.funny{background:var(--cat-funny-bg);color:var(--cat-funny)}
  .cat-badge.note{background:var(--cat-note-bg);color:var(--cat-note)}
  .cat-badge.neat{background:var(--cat-neat-bg);color:var(--cat-neat)}

  .item-actions{display:flex;gap:4px;}
  .icon-btn{width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; border: none; background: transparent; color: var(--text-muted); border-radius: 4px; cursor: pointer; transition: all var(--transition);}
  .icon-btn:hover { background: var(--bg-hover); color: var(--text); }
  .icon-btn.active-pin { color: var(--accent); }
  .icon-btn.delete:hover { color: var(--danger); background: var(--danger-bg); }
  
  /* REVIEW CATEGORY BUTTONS */
  .review-cats{display:flex;gap:4px;flex-wrap:wrap; width: 100%; margin-top: 4px;}
  .review-cat-btn{flex: 1; font-family:var(--font);font-size:12px;font-weight:500;padding:6px;border:1px solid var(--border-subtle);background:transparent;border-radius:6px;cursor:pointer;transition:all var(--transition);color:var(--text-muted)}
  .review-cat-btn:hover{background: var(--bg-hover);}
  .review-cat-btn.selected{font-weight:600; border-color: transparent;}
  /* Use same colors as chips */
  .review-cat-btn[data-cat="quote"].selected{color:var(--cat-quote);background:var(--cat-quote-bg);}
  .review-cat-btn[data-cat="first"].selected{color:var(--cat-first);background:var(--cat-first-bg);}
  .review-cat-btn[data-cat="funny"].selected{color:var(--cat-funny);background:var(--cat-funny-bg);}
  .review-cat-btn[data-cat="note"].selected{color:var(--cat-note);background:var(--cat-note-bg);}
  .review-cat-btn[data-cat="neat"].selected{color:var(--cat-neat);background:var(--cat-neat-bg);}

  /* TIMELINE */
  .timeline-toolbar{display:flex;flex-direction: column; gap:12px; margin-bottom:20px;}
  .search-row {display: flex; gap: 8px;}
  .input-wrap{flex:1;position:relative}
  .input-wrap input{width:100%;font-family:var(--font);font-size:14px;padding:10px 34px 10px 14px;background:var(--bg-surface);border:1px solid transparent;border-radius:10px;color:var(--text);outline:none;transition:all var(--transition);box-shadow:var(--shadow-sm)}
  .input-wrap input:focus{background:var(--bg-surface); box-shadow: 0 0 0 2px var(--accent-glow);}
  .input-clear{position:absolute;right:8px;top:50%;transform:translateY(-50%);width:20px;height:20px;border-radius:50%;border:none;background:var(--bg-hover);color:var(--text-muted);cursor:pointer;font-size:12px;display:none;align-items:center;justify-content:center;}
  .input-wrap.has-value .input-clear{display:flex}

  .cat-filters{display:flex;gap:6px;overflow-x: auto; padding-bottom: 4px; -webkit-overflow-scrolling: touch;}
  .cat-filters::-webkit-scrollbar{display:none;}
  .cat-filter-btn{font-family:var(--font);font-size:13px;font-weight:500;padding:6px 14px;border:1px solid transparent;background:var(--bg-surface);border-radius:100px;cursor:pointer;white-space: nowrap; color:var(--text-secondary); box-shadow: var(--shadow-sm);}
  .cat-filter-btn.active-all{background:var(--text);color:var(--bg); }
  .cat-filter-btn.active-quote{background:var(--cat-quote-bg);color:var(--cat-quote);}
  /* ... add other active states same as chips */

  .date-group-label{font-family:var(--font-display);font-size:14px;font-weight:600;color:var(--text-secondary);padding:20px 0 8px;position: sticky; top: 70px; background: var(--bg); z-index: 10; opacity: 0.9;}

  /* SETTINGS */
  .settings-bar{padding:30px 0;margin-top: 20px; border-top:1px solid var(--border-subtle);display:flex;flex-direction: column; gap:16px;}
  .settings-row {display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 10px;}
  .subtle-btn{font-family:var(--font);font-size:12px;padding:8px 12px;border:1px solid var(--border-subtle);background:transparent;color:var(--text-secondary);border-radius:8px;cursor:pointer;transition:all var(--transition)}
  .subtle-btn:hover{background:var(--bg-hover); color:var(--text);}
  .subtle-btn.danger{color: var(--danger); border-color: rgba(184,90,82,0.2);}
  .stats-text{font-family:var(--mono);font-size:11px;color:var(--text-muted)}

  /* MODAL */
  .modal-overlay{position:fixed;inset:0;background:var(--modal-overlay);backdrop-filter:blur(4px);z-index:500;display:none;align-items:center;justify-content:center;padding:20px}
  .modal-overlay.open{display:flex}
  .modal{background:var(--bg-elevated);border-radius:var(--radius-lg);padding:24px;max-width:400px;width:100%;box-shadow:var(--shadow-md); border: 1px solid var(--border-subtle);}
  .modal h3{font-family:var(--font-display);font-size:20px;margin-bottom:8px; color: var(--text);}
  .modal p{font-size:14px;color:var(--text-secondary);margin-bottom:20px;line-height:1.5}
  .modal-input{width:100%;padding:12px;margin-bottom:16px;border:1px solid var(--border-subtle);border-radius:8px;font-family:var(--font);font-size:16px;color:var(--text);background:var(--bg);outline:none}
  .modal-input:focus{border-color:var(--accent);}
  .modal-actions{display:flex;gap:10px;justify-content:flex-end}
  .modal-btn{font-family:var(--font);font-size:14px;font-weight:600;padding:10px 20px;border-radius:8px;cursor:pointer;border:none;}
  .modal-btn.primary{background:var(--accent);color:#fff}

  /* FLASH & UNDO */
  .capture-flash{position:fixed;top:20px;left:50%;transform:translateX(-50%) translateY(-60px);background:var(--bg-surface);border:1px solid var(--border);color:var(--text);padding:10px 24px;border-radius:100px;font-size:14px;font-weight:500;opacity:0;transition:all 300ms cubic-bezier(0.175, 0.885, 0.32, 1.275);z-index:900;pointer-events:none;box-shadow:var(--shadow-md); display: flex; align-items: center; gap: 8px;}
  .capture-flash.show{opacity:1;transform:translateX(-50%) translateY(0)}
  .undo-toast{position:fixed;bottom:90px;left:50%;transform:translateX(-50%) translateY(20px);background:var(--undo-bg);color:var(--undo-text);padding:12px 20px;border-radius:100px;font-size:14px;display:flex;align-items:center;gap:12px;opacity:0;transition:all 300ms ease;z-index:900;box-shadow:0 8px 24px rgba(0,0,0,.2); width: max-content;}
  .undo-toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
  .undo-toast button{font-weight:700; background: none; border: none; color: inherit; cursor: pointer; text-decoration: underline;}

  /* RESPONSIVE */
  @media(max-width:600px){
    nav.desktop-nav { display: none; }
    nav.mobile-nav { display: flex; }
    .header-right { gap: 4px; }
    .app { padding: 0 16px; }
    .review-cats { overflow-x: auto; padding-bottom: 4px; }
    .review-cat-btn { white-space: nowrap; flex: none; }
    .undo-toast { bottom: 100px; }
  }
  .hidden{display:none!important}
</style>
</head>
<body data-theme="light">
<div class="app">
  <header>
    <div class="header-left">
      <div class="logo"><div class="logo-mark">p</div><div class="logo-text">pocketpip</div></div>
      <div class="child-selector" id="child-selector">
        <button class="child-active-btn" id="child-active-btn"><span id="child-active-name">Malcolm</span><span class="child-arrow">&#9662;</span></button>
        <div class="child-dropdown" id="child-dropdown"></div>
      </div>
    </div>
    <div class="header-right">
      <button class="theme-toggle" id="theme-toggle" title="Toggle dark mode">&#9788;</button>
      <nav class="desktop-nav" id="nav-desktop">
        <button class="active" data-view="capture">Capture</button>
        <button data-view="review">Review <span class="badge hidden" id="review-badge-desk">0</span></button>
        <button data-view="timeline">Timeline</button>
      </nav>
    </div>
  </header>
  <main>
    <section id="view-capture" class="capture-view">
      <div class="capture-prompt" id="capture-prompt">new pip for Malcolm</div>
      <div class="capture-input-wrap">
        <textarea class="capture-input" id="capture-input" placeholder="a small thing worth keeping..." rows="3"></textarea>
        <div class="capture-char-count" id="char-count">0</div>
      </div>
      <div class="category-bar" id="category-bar">
        <button class="cat-chip" data-cat="quote">Quote</button>
        <button class="cat-chip" data-cat="first">First</button>
        <button class="cat-chip" data-cat="funny">Funny</button>
        <button class="cat-chip" data-cat="neat">Neat</button>
        <button class="cat-chip" data-cat="note">Note</button>
      </div>
      <div class="capture-meta">
        <div class="tag-container" id="tag-container">
          <input type="text" class="tag-select-input" id="tag-input" placeholder="# Add tags..." autocomplete="off">
          <div class="tag-dropdown" id="tag-dropdown"></div>
        </div>
        <button class="capture-btn" id="capture-btn">Pocket it</button>
      </div>
      <div class="date-row">
        <button class="text-btn" id="date-yest-btn">Yesterday</button>
        <button class="text-btn" id="date-now-btn" style="font-weight:600">Now</button>
        <input type="datetime-local" class="date-override-input" id="date-override">
      </div>
    </section>
    
    <section id="view-review" class="hidden">
      <div class="review-header"><h2 class="review-title">Review</h2><span class="stats-text" id="review-count"></span></div>
      <div id="review-list"></div>
    </section>
    
    <section id="view-timeline" class="hidden">
      <div class="timeline-toolbar">
        <div class="search-row">
          <div class="input-wrap" id="search-wrap"><input type="text" id="search-input" placeholder="Search..."><button class="input-clear" id="search-clear">&times;</button></div>
          <select class="subtle-btn" id="sort-select" style="border-radius:10px; height: 100%;"><option value="newest">Newest</option><option value="oldest">Oldest</option></select>
        </div>
        <div class="cat-filters" id="cat-filters">
          <button class="cat-filter-btn active-all" data-cat="all">All</button>
          <button class="cat-filter-btn" data-cat="quote">Quotes</button>
          <button class="cat-filter-btn" data-cat="first">Firsts</button>
          <button class="cat-filter-btn" data-cat="funny">Funny</button>
          <button class="cat-filter-btn" data-cat="neat">Neat</button>
          <button class="cat-filter-btn" data-cat="note">Notes</button>
          <button class="cat-filter-btn" data-cat="uncategorised">Inbox</button>
        </div>
      </div>
      <div id="timeline-list"></div>
    </section>
  </main>
  
  <div class="settings-bar">
    <div class="settings-row">
      <button class="subtle-btn" id="manual-sync-btn"><span id="sync-label">Sync</span></button>
      <span class="stats-text" id="stats-text"></span>
    </div>
    <div class="settings-row" style="justify-content: flex-start; gap: 8px;">
      <button class="subtle-btn" id="cloud-btn">Cloud</button>
      <button class="subtle-btn" id="diagnose-btn">Diagnose</button>
      <button class="subtle-btn" id="export-btn">Backup</button>
      <button class="subtle-btn" id="import-btn">Restore</button>
      <button class="subtle-btn danger" id="purge-btn" style="display:none">Empty Trash</button>
      <button class="subtle-btn danger" id="clear-btn">Reset</button>
    </div>
  </div>
</div>

<nav class="mobile-nav" id="nav-mobile">
  <button class="active" data-view="capture">
    <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm5 11h-4v4h-2v-4H7v-2h4V7h2v4h4v2z"/></svg>
    Capture
  </button>
  <button data-view="review">
    <div class="badge hidden" id="review-badge-mob" style="top:2px; right:12px; box-shadow:none;">0</div>
    <svg viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92 1.61 0 2.92-1.31 2.92-2.92s-1.31-2.92-2.92-2.92z"/></svg>
    Review
  </button>
  <button data-view="timeline">
    <svg viewBox="0 0 24 24"><path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM7 10h5v5H7z"/></svg>
    Timeline
  </button>
</nav>

<div class="capture-flash" id="capture-flash"><span>&#10003;</span> <span id="flash-text">Saved</span></div>
<div class="undo-toast" id="undo-toast"><span id="undo-text">Removed</span><button id="undo-btn">Undo</button></div>
<div class="modal-overlay" id="modal-overlay"><div class="modal"><h3 id="modal-title">Confirm</h3><p id="modal-body">Are you sure?</p><div id="modal-content"></div><div class="modal-actions"><button class="modal-btn" id="modal-cancel">Cancel</button><button class="modal-btn primary" id="modal-confirm">Confirm</button></div></div></div>
<input type="file" id="import-file" accept=".json" style="display:none">

<script>

// =============================================================================
// CONSTANTS & STORAGE KEYS
// =============================================================================

const STORAGE_KEY      = 'pocketpip_data';
const CLOUD_URL_KEY    = 'pocketpip_cloud_url';
const CLOUD_KEY_STORAGE = 'pocketpip_cloud_key';
const SYNC_LOG_KEY     = 'pocketpip_sync_log';
const THEME_KEY        = 'pocketpip_theme';
const ACTIVE_CHILD_KEY = 'pocketpip_active_child';
const CATEGORIES       = ['quote', 'first', 'funny', 'neat', 'note'];


// =============================================================================
// DATA — load, save, migrate
// =============================================================================

function loadData() {
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return defaultData();

    const d = JSON.parse(raw);

    // Ensure required arrays exist
    if (!Array.isArray(d.items))    d.items    = [];
    if (!Array.isArray(d.tags))     d.tags     = [];
    if (!Array.isArray(d.children)) d.children = ['Malcolm'];

    // Strip any completely broken items (must have id and text strings)
    d.items = d.items.filter(i => i && typeof i.id === 'string' && typeof i.text === 'string');

    // Migrate old item shapes — fill in missing fields
    d.items.forEach(i => {
      if (!Array.isArray(i.tags))        i.tags     = i.tag ? [i.tag] : [];
      if (!i.category)                   i.category  = '';
      if (!i.createdAt)                  i.createdAt = new Date().toISOString();
      if (typeof i.pinned === 'undefined') i.pinned  = false;
      if (!i.childName)                  i.childName = d.children[0] || 'Malcolm';
      delete i.tag; // remove old single-tag field
    });

    // Prune soft-deleted items older than 30 days
    const THIRTY_DAYS = 30 * 24 * 60 * 60 * 1000;
    d.items = d.items.filter(i => {
      if (!i._deleted) return true;
      if (!i._deletedAt) return false;
      return (Date.now() - new Date(i._deletedAt).getTime()) < THIRTY_DAYS;
    });

    return d;
  } catch (e) {
    console.error('Load error:', e);
    return defaultData();
  }
}

function defaultData() {
  return { children: ['Malcolm'], tags: [], items: [] };
}

// _ss (skip sync) flag: set true during cloud merge to prevent re-triggering sync
let _ss = false;

function saveData(d) {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(d));
  if (!_ss) triggerCloudSync(d);
}

let data = loadData();


// =============================================================================
// CHILDREN — multi-child support
// =============================================================================

let activeChild = localStorage.getItem(ACTIVE_CHILD_KEY) || data.children[0] || 'Malcolm';

// If stored active child no longer exists in data, fall back to first
if (!data.children.includes(activeChild)) {
  activeChild = data.children[0] || 'Malcolm';
  if (!data.children.includes(activeChild)) data.children.push(activeChild);
}

function setActiveChild(name) {
  activeChild = name;
  localStorage.setItem(ACTIVE_CHILD_KEY, name);
  document.getElementById('child-active-name').textContent = name;
  document.title = 'pocketpip \u2014 ' + name;
  document.getElementById('capture-prompt').textContent = 'new pip for ' + name;
  renderChildDropdown();
  renderCurrentView();
}

function addChild(name) {
  const trimmed = name.trim();
  if (!trimmed) return false;
  if (data.children.some(x => x.toLowerCase() === trimmed.toLowerCase())) return false;
  data.children.push(trimmed);
  data.children.sort((a, b) => a.toLowerCase().localeCompare(b.toLowerCase()));
  saveData(data);
  setActiveChild(trimmed);
  return true;
}

function removeChild(name) {
  if (data.children.length <= 1) return;
  data.children = data.children.filter(c => c !== name);
  // Soft-delete all items belonging to the removed child
  data.items.forEach(i => {
    if (i.childName === name && !i._deleted) {
      i._deleted = true;
      i._deletedAt = new Date().toISOString();
    }
  });
  saveData(data);
  if (activeChild === name) setActiveChild(data.children[0]);
  else renderChildDropdown();
}

function renderChildDropdown() {
  const dd = document.getElementById('child-dropdown');
  let html = '';

  data.children.forEach(name => {
    const isActive = name === activeChild;
    const removeBtn = data.children.length > 1
      ? `<span class="child-remove" data-name="${ea(name)}" title="Remove">&times;</span>`
      : '';
    html += `<div class="child-option ${isActive ? 'active' : ''}" data-name="${ea(name)}">${eh(name)}${removeBtn}</div>`;
  });

  html += '<div class="child-add-option" id="child-add-option">+ Add child</div>';
  dd.innerHTML = html;

  // Switch child on click
  dd.querySelectorAll('.child-option').forEach(opt => {
    opt.addEventListener('click', e => {
      if (e.target.classList.contains('child-remove')) return;
      setActiveChild(opt.dataset.name);
      dd.classList.remove('open');
    });
  });

  // Remove child on × click
  dd.querySelectorAll('.child-remove').forEach(btn => {
    btn.addEventListener('click', e => {
      e.stopPropagation();
      const name = btn.dataset.name;
      modal.open(
        'Remove ' + name + '?',
        'This will remove ' + name + ' and soft-delete all their moments.',
        null,
        () => removeChild(name),
        'Remove',
        true
      );
    });
  });

  // Add child
  document.getElementById('child-add-option').addEventListener('click', () => {
    dd.classList.remove('open');
    modal.open(
      'Add a child',
      'Enter their name.',
      ct => {
        const inp = document.createElement('input');
        inp.type = 'text';
        inp.className = 'modal-input';
        inp.id = 'new-child-input';
        inp.placeholder = 'Name';
        inp.addEventListener('keydown', e => {
          if (e.key === 'Enter') { e.preventDefault(); modal.confirm.click(); }
        });
        ct.appendChild(inp);
      },
      () => {
        const name = document.getElementById('new-child-input').value.trim();
        if (name) {
          if (!addChild(name)) showFlash('Name exists');
          else showFlash(name + ' added');
        }
      },
      'Add'
    );
  });
}

// Toggle child dropdown open/close
document.getElementById('child-active-btn').addEventListener('click', e => {
  e.stopPropagation();
  document.getElementById('child-dropdown').classList.toggle('open');
});

// Close child dropdown when clicking outside
document.addEventListener('click', e => {
  if (!e.target.closest('.child-selector')) {
    document.getElementById('child-dropdown').classList.remove('open');
  }
});


// =============================================================================
// SYNC — cloud read/write via Google Apps Script
// =============================================================================

let cloudUrl     = localStorage.getItem(CLOUD_URL_KEY) || '';
let syncTimeout  = null;
let lastSyncTime = null;

const syncBtn   = document.getElementById('manual-sync-btn');
const syncLabel = document.getElementById('sync-label');

// --- Sync log (persisted, last 20 events) ---

function getSyncLog() {
  try { return JSON.parse(localStorage.getItem(SYNC_LOG_KEY) || '[]'); }
  catch { return []; }
}

function addSyncLog(direction, status, detail) {
  const log = getSyncLog();
  log.unshift({ ts: new Date().toISOString(), direction, status, detail: detail || '' });
  if (log.length > 20) log.pop();
  localStorage.setItem(SYNC_LOG_KEY, JSON.stringify(log));
}

function clearSyncLog() {
  localStorage.removeItem(SYNC_LOG_KEY);
}

// --- Status display ---

function setSyncStatus(state, text) {
  syncBtn.className = 'subtle-btn';
  if (state === 'loading') {
    syncLabel.textContent = 'Syncing…';
  } else if (state === 'ok') {
    syncLabel.textContent = text || 'Synced';
  } else if (state === 'error') {
    syncBtn.classList.add('danger');
    syncLabel.textContent = text || 'Sync error';
  } else {
    syncLabel.textContent = cloudUrl ? 'Sync' : 'No cloud';
  }
}

syncBtn.addEventListener('click', () => {
  if (cloudUrl && validateCloudUrl(cloudUrl)) fetchCloudData();
  else document.getElementById('cloud-btn').click();
});

// --- Validation ---

function validateCloudUrl(url) {
  if (!url) return false;
  try {
    const u = new URL(url);
    return u.hostname === 'script.google.com' && u.pathname.startsWith('/macros/s/');
  } catch {
    return false;
  }
}

function validateCloudData(d) {
  // Only reject if the shape is fundamentally wrong.
  // Individual bad items are filtered in sanitizeCloudItem rather than failing the whole pull.
  if (!d || typeof d !== 'object') return { ok: false, reason: 'Response is not an object' };
  if (!Array.isArray(d.items))     return { ok: false, reason: 'Response has no items array' };
  return { ok: true };
}

function sanitizeCloudItem(item, children) {
  // Return null for items that are too broken to use — caller should filter these out
  if (!item || typeof item.id === 'undefined' || typeof item.text === 'undefined') return null;
  return {
    id:        String(item.id).slice(0, 50),
    text:      String(item.text).slice(0, 10000),
    tags:      Array.isArray(item.tags) ? item.tags.map(t => String(t).slice(0, 100)).slice(0, 20) : [],
    category:  CATEGORIES.includes(item.category) ? item.category : '',
    childName: typeof item.childName === 'string' ? item.childName.slice(0, 100) : (children[0] || 'Unknown'),
    createdAt: item.createdAt || new Date().toISOString(),
    updatedAt: item.updatedAt || null,
    pinned:    !!item.pinned,
    _deleted:  !!item._deleted,
    _deletedAt: item._deletedAt || null,
  };
}

function getCloudSecret() {
  return localStorage.getItem(CLOUD_KEY_STORAGE) || '';
}

function buildUrlWithKey(url) {
  const sep = url.includes('?') ? '&' : '?';
  return url + sep + 'key=' + encodeURIComponent(getCloudSecret());
}

// --- Pull from cloud ---

function fetchCloudData() {
  if (!cloudUrl || !validateCloudUrl(cloudUrl)) return;

  setSyncStatus('loading', 'Pulling…');

  fetch(buildUrlWithKey(cloudUrl), { method: 'GET', redirect: 'follow' })
    .then(r => {
      if (!r.ok) throw new Error('HTTP ' + r.status + ' — server rejected request');
      return r.json();
    })
    .then(cloudData => {
      // Script-level error
      if (cloudData.error) {
        addSyncLog('pull', 'error', 'Script error: ' + cloudData.error);
        setSyncStatus('error', 'Cloud: ' + cloudData.error.slice(0, 30));
        return;
      }

      // Shape check
      const valid = validateCloudData(cloudData);
      if (!valid.ok) {
        addSyncLog('pull', 'error', 'Bad response: ' + valid.reason);
        setSyncStatus('error', 'Bad cloud data: ' + valid.reason.slice(0, 25));
        return;
      }

      const cloudChildren = Array.isArray(cloudData.children) ? cloudData.children : ['Malcolm'];

      // Sanitize — filter out null (broken) items rather than aborting the whole pull
      const cloudItems = cloudData.items.map(i => sanitizeCloudItem(i, cloudChildren)).filter(Boolean);
      const skipped = cloudData.items.length - cloudItems.length;
      if (skipped > 0) addSyncLog('pull', 'warn', skipped + ' malformed item(s) skipped from cloud');

      // Merge: cloud map + local map → merged map
      const cloudMap = new Map(cloudItems.map(i => [i.id, i]));
      const localMap = new Map(data.items.map(i => [i.id, i]));
      const merged   = new Map();
      let newFromCloud = 0, conflicts = 0;

      for (const [id, cloudItem] of cloudMap) {
        const localItem = localMap.get(id);

        if (!localItem) {
          // Item only exists on cloud — take it
          merged.set(id, cloudItem);
          newFromCloud++;
          continue;
        }

        // If either copy is deleted, mark as deleted (deletion wins)
        if (cloudItem._deleted || localItem._deleted) {
          const winner = cloudItem._deleted ? cloudItem : localItem;
          merged.set(id, { ...winner, _deleted: true, _deletedAt: winner._deletedAt || new Date().toISOString() });
          continue;
        }

        // Both exist — most recently updated wins
        const cloudTime = new Date(cloudItem.updatedAt || cloudItem.createdAt);
        const localTime = new Date(localItem.updatedAt || localItem.createdAt);
        if (cloudTime.getTime() !== localTime.getTime()) conflicts++;
        merged.set(id, localTime > cloudTime ? localItem : cloudItem);
      }

      // Items only on local — keep them
      for (const [id, localItem] of localMap) {
        if (!merged.has(id)) merged.set(id, localItem);
      }

      // Commit merge to local state
      _ss = true;
      data.items = Array.from(merged.values());
      data.items.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

      // Merge children lists
      cloudChildren.forEach(c => { if (!data.children.includes(c)) data.children.push(c); });
      data.children.sort((a, b) => a.toLowerCase().localeCompare(b.toLowerCase()));

      // Merge tags
      if (Array.isArray(cloudData.tags)) {
        cloudData.tags.forEach(t => {
          const clean = String(t).slice(0, 100);
          if (clean && !data.tags.includes(clean)) data.tags.push(clean);
        });
      }

      saveData(data);
      _ss = false;

      addSyncLog('pull', 'ok',
        'Pull OK · ' + cloudItems.length + ' cloud items · ' + newFromCloud + ' new · ' + conflicts + ' conflicts'
      );

      // Push merged result back so cloud stays in sync
      pushToCloud(data);
      renderChildDropdown();
      renderCurrentView();
      lastSyncTime = new Date();
      setSyncStatus('ok', 'Synced ' + formatTime(lastSyncTime.toISOString()));
    })
    .catch(e => {
      console.error('Sync pull error:', e);
      _ss = false;

      const msg = e.message || String(e) || 'Unknown error';
      addSyncLog('pull', 'error', 'catch: ' + msg);

      // Translate technical errors into plain English for the status bar
      let friendly;
      if (msg.includes('Failed to fetch') || msg.includes('NetworkError') || msg.includes('network'))
        friendly = 'No internet connection';
      else if (msg.includes('HTTP 401') || msg.includes('HTTP 403'))
        friendly = 'Access denied — check key';
      else if (msg.includes('HTTP 404'))
        friendly = 'Script not found — check URL';
      else if (msg.includes('HTTP 5'))
        friendly = 'Google server error — try again';
      else if (msg.toLowerCase().includes('json') || msg.includes('SyntaxError'))
        friendly = 'Bad response — script returned non-JSON';
      else
        friendly = 'Pull failed: ' + msg.slice(0, 30);

      setSyncStatus('error', friendly);
    });
}

// --- Push to cloud ---

function pushToCloud(d) {
  if (!cloudUrl || !validateCloudUrl(cloudUrl)) return Promise.resolve();

  const payload = { ...d, key: getCloudSecret(), _pushedAt: new Date().toISOString() };

  return fetch(cloudUrl, { method: 'POST', redirect: 'follow', body: JSON.stringify(payload) })
    .then(r => {
      if (!r.ok) throw new Error('HTTP ' + r.status);
      return r.json();
    })
    .then(response => {
      if (response.error) {
        addSyncLog('push', 'error', response.error);
        setSyncStatus('error', 'Push: ' + response.error.slice(0, 30));
        return;
      }
      lastSyncTime = new Date();
      addSyncLog('push', 'ok', d.items.filter(i => !i._deleted).length + ' items pushed');
      setSyncStatus('ok', 'Synced ' + formatTime(lastSyncTime.toISOString()));
    })
    .catch(e => {
      console.error('Push error:', e);
      const msg = e.message || 'Unknown error';
      addSyncLog('push', 'error', msg);
      let friendly = 'Push failed';
      if (msg.includes('Failed to fetch') || msg.includes('NetworkError')) friendly = 'No internet';
      else if (msg.includes('HTTP 4')) friendly = 'Push rejected — check URL/key';
      setSyncStatus('error', friendly);
    });
}

// --- Debounced sync trigger (fires after user stops making changes) ---

function triggerCloudSync(d) {
  if (!cloudUrl || !validateCloudUrl(cloudUrl)) return;
  setSyncStatus('loading', 'Saving…');
  clearTimeout(syncTimeout);
  syncTimeout = setTimeout(() => pushToCloud(d), 1500);
}

// --- Test connection (used by Cloud modal and Diagnose panel) ---

function testCloudConnection(url, key) {
  return new Promise(resolve => {
    if (!validateCloudUrl(url)) {
      resolve({ ok: false, msg: 'Invalid URL format — must be a script.google.com URL' });
      return;
    }

    const testUrl = url + (url.includes('?') ? '&' : '?') + 'key=' + encodeURIComponent(key || '');
    const timeout = setTimeout(
      () => resolve({ ok: false, msg: 'Timed out after 10s — script may be sleeping or URL wrong' }),
      10000
    );

    fetch(testUrl, { method: 'GET', redirect: 'follow' })
      .then(r => {
        clearTimeout(timeout);
        if (!r.ok) throw new Error('HTTP ' + r.status);
        return r.json();
      })
      .then(cd => {
        if (cd.error) {
          resolve({ ok: false, msg: 'Script returned error: ' + cd.error });
          return;
        }
        if (!Array.isArray(cd.items)) {
          resolve({ ok: false, msg: 'Unexpected response — is this the right script?' });
          return;
        }
        resolve({ ok: true, msg: 'Connected! Found ' + cd.items.length + ' item(s) on cloud.' });
      })
      .catch(e => {
        clearTimeout(timeout);
        let msg = e.message || 'Network error';
        if (msg.includes('Failed to fetch'))
          msg = 'Could not reach Google — check your internet connection';
        else if (msg.includes('HTTP 401') || msg.includes('HTTP 403'))
          msg = 'Access denied — wrong key, or script not set to "Anyone can access"';
        else if (msg.includes('HTTP 404'))
          msg = 'Script not found — URL may be wrong or script was deleted';
        resolve({ ok: false, msg });
      });
  });
}

// --- Sync diagnostics panel ---

function showSyncDiagnostics() {
  const log      = getSyncLog();
  const hasCloud = !!(cloudUrl && validateCloudUrl(cloudUrl));

  modal.open(
    'Sync Diagnostics',
    hasCloud
      ? 'Cloud is configured. Recent sync history below.'
      : 'No cloud URL configured. Set one via the Cloud button.',
    ct => {
      // Status summary
      const summary = document.createElement('div');
      summary.style.cssText = 'font-size:13px;margin-bottom:12px;padding:10px;background:var(--bg-hover);border-radius:8px;line-height:1.7';
      summary.innerHTML =
        '<b>URL:</b> '   + (hasCloud          ? '✓ Configured'                  : '✗ Not set') + '<br>' +
        '<b>Key:</b> '   + (getCloudSecret()  ? '✓ Set'                         : '✗ Not set') + '<br>' +
        '<b>Last sync:</b> ' + (lastSyncTime  ? formatTime(lastSyncTime.toISOString()) : 'Never this session') + '<br>' +
        '<b>Local items:</b> ' + data.items.filter(i => !i._deleted).length;
      ct.appendChild(summary);

      // Live test button
      if (hasCloud) {
        const testBtn = document.createElement('button');
        testBtn.className = 'subtle-btn';
        testBtn.style.cssText = 'width:100%;margin-bottom:12px;font-size:13px';
        testBtn.textContent = '▶ Test Connection Now';
        testBtn.addEventListener('click', async () => {
          testBtn.textContent = 'Testing…';
          testBtn.disabled = true;
          const result = await testCloudConnection(cloudUrl, getCloudSecret());
          testBtn.textContent = (result.ok ? '✓ ' : '✗ ') + result.msg;
          testBtn.style.color = result.ok ? 'var(--cat-first)' : 'var(--danger)';
          testBtn.disabled = false;
        });
        ct.appendChild(testBtn);
      }

      // Sync log
      const logTitle = document.createElement('div');
      logTitle.style.cssText = 'font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.05em;color:var(--text-muted);margin-bottom:6px';
      logTitle.textContent = 'Recent Sync Events';
      ct.appendChild(logTitle);

      const logWrap = document.createElement('div');
      logWrap.style.cssText = 'max-height:200px;overflow-y:auto;font-family:var(--mono);font-size:11px;line-height:1.6;background:var(--bg-hover);border-radius:8px;padding:10px';

      if (!log.length) {
        logWrap.textContent = 'No sync events recorded yet.';
        logWrap.style.color = 'var(--text-muted)';
      } else {
        logWrap.innerHTML = log.map(entry => {
          const time  = new Date(entry.ts).toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
          const date  = new Date(entry.ts).toLocaleDateString('en-GB', { day: 'numeric', month: 'short' });
          const icon  = entry.status === 'ok' ? '✓' : entry.status === 'warn' ? '⚠' : '✗';
          const color = entry.status === 'ok' ? 'var(--cat-first)' : entry.status === 'warn' ? 'var(--cat-funny)' : 'var(--danger)';
          return `<div style="border-bottom:1px solid var(--border-subtle);padding:3px 0">` +
                 `<span style="color:${color}">${icon}</span> ` +
                 `<span style="color:var(--text-muted)">${date} ${time}</span> ` +
                 `<b>${entry.direction}</b> ${eh(entry.detail)}</div>`;
        }).join('');
      }
      ct.appendChild(logWrap);

      // Clear log
      if (log.length) {
        const clearBtn = document.createElement('button');
        clearBtn.className = 'subtle-btn';
        clearBtn.style.cssText = 'margin-top:10px;font-size:12px';
        clearBtn.textContent = 'Clear Log';
        clearBtn.addEventListener('click', () => { clearSyncLog(); modal.close(); showSyncDiagnostics(); });
        ct.appendChild(clearBtn);
      }

      // Common fixes reference
      const fixTitle = document.createElement('div');
      fixTitle.style.cssText = 'font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.05em;color:var(--text-muted);margin:12px 0 6px';
      fixTitle.textContent = 'Common Fixes';
      ct.appendChild(fixTitle);

      const fixes = document.createElement('div');
      fixes.style.cssText = 'font-size:12px;color:var(--text-secondary);line-height:1.8';
      fixes.innerHTML =
        '• "No internet" → Check wifi/data, try again<br>' +
        '• "Access denied" → Re-deploy script as <i>Anyone</i><br>' +
        '• "Script not found" → Redeploy &amp; copy new URL<br>' +
        '• "Bad cloud data" → Script may need updating<br>' +
        '• Other device not seeing data → They need to tap Sync<br>' +
        '• Still stuck → Use Backup/Restore to transfer manually';
      ct.appendChild(fixes);
    },
    null, 'Close', false
  );

  // Diagnostics is read-only — hide Confirm, relabel Cancel as Close
  document.getElementById('modal-confirm').classList.add('hidden');
  document.getElementById('modal-cancel').textContent = 'Close';
}

// Auto-sync when tab becomes visible again
document.addEventListener('visibilitychange', () => {
  if (!document.hidden && cloudUrl) fetchCloudData();
});

// Kick off initial sync on load
if (cloudUrl && validateCloudUrl(cloudUrl)) {
  setSyncStatus('loading', 'Connecting…');
  setTimeout(fetchCloudData, 500);
}


// =============================================================================
// CORE DATA OPERATIONS
// =============================================================================

function addItem(text, category, tags, dateOverride) {
  const item = {
    id:        Date.now().toString(36) + Math.random().toString(36).slice(2, 6),
    text:      text.trim(),
    category:  category || '',
    tags:      (tags || []).map(t => t.trim()).filter(Boolean),
    childName: activeChild,
    createdAt: dateOverride || new Date().toISOString(),
    updatedAt: new Date().toISOString(),
    pinned:    false,
  };

  data.items.unshift(item);
  data.items.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

  // Register any new tags
  item.tags.forEach(t => { if (!data.tags.includes(t)) data.tags.push(t); });
  data.tags.sort((a, b) => a.toLowerCase().localeCompare(b.toLowerCase()));

  saveData(data);
  return item;
}

function updateItem(id, updates) {
  const item = data.items.find(i => i.id === id);
  if (!item) return;
  Object.assign(item, updates, { updatedAt: new Date().toISOString() });
  if (updates.tags) {
    updates.tags.forEach(t => { if (!data.tags.includes(t)) data.tags.push(t); });
  }
  saveData(data);
}

function togglePin(id) {
  const item = data.items.find(i => i.id === id);
  if (item) { item.pinned = !item.pinned; saveData(data); }
}

function deleteItem(id) {
  const item = data.items.find(i => i.id === id);
  if (!item) return null;
  item._deleted = true;
  item._deletedAt = new Date().toISOString();
  saveData(data);
  // Return a clean (undeleted) copy for undo
  return { ...item, _deleted: false, _deletedAt: null };
}

function restoreItem(item) {
  if (!item) return;
  const existing = data.items.find(i => i.id === item.id);
  if (existing) {
    existing._deleted = false;
    existing._deletedAt = null;
  } else {
    item._deleted = false;
    item._deletedAt = null;
    data.items.push(item);
  }
  data.items.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
  saveData(data);
}

function purgeAllDeleted() {
  data.items = data.items.filter(i => !i._deleted);
  saveData(data);
}

// --- Queries ---

function getChildItems() {
  return data.items.filter(i => i.childName === activeChild && !i._deleted);
}

function getUncategorised() {
  return data.items.filter(i => i.childName === activeChild && !i.category && !i._deleted);
}

function getActiveItems() {
  return data.items.filter(i => !i._deleted);
}

function searchItems(query, tag, category, sort) {
  let results = data.items.filter(i => i.childName === activeChild && !i._deleted);

  if (category && category !== 'all') {
    if (category === 'uncategorised') results = results.filter(i => !i.category);
    else results = results.filter(i => i.category === category);
  }

  if (tag) {
    results = results.filter(i =>
      Array.isArray(i.tags) && i.tags.some(t => t.toLowerCase() === tag.toLowerCase())
    );
  }

  if (query) {
    const q = query.toLowerCase();
    results = results.filter(i =>
      i.text.toLowerCase().includes(q) ||
      (Array.isArray(i.tags) && i.tags.some(t => t.toLowerCase().includes(q)))
    );
  }

  results.sort((a, b) => {
    if (a.pinned && !b.pinned) return -1;
    if (!a.pinned && b.pinned) return 1;
    const da = new Date(a.createdAt), db = new Date(b.createdAt);
    return sort === 'oldest' ? da - db : db - da;
  });

  return results;
}


// =============================================================================
// UNDO
// =============================================================================

let undoStack = [];
let undoTimer = null;

const undoToast = document.getElementById('undo-toast');
const undoText  = document.getElementById('undo-text');

function pushUndo(label, item) {
  undoStack = [{ label, item }];
  undoText.textContent = label;
  undoToast.classList.add('show');
  clearTimeout(undoTimer);
  undoTimer = setTimeout(() => {
    undoToast.classList.remove('show');
    undoStack = [];
  }, 6000);
}

document.getElementById('undo-btn').addEventListener('click', () => {
  if (!undoStack.length) return;
  restoreItem(undoStack.pop().item);
  undoToast.classList.remove('show');
  clearTimeout(undoTimer);
  renderCurrentView();
});


// =============================================================================
// THEME
// =============================================================================

const themeToggle = document.getElementById('theme-toggle');
let currentTheme  = localStorage.getItem(THEME_KEY) || 'light';
applyTheme(currentTheme);

function applyTheme(theme) {
  currentTheme = theme;
  document.body.setAttribute('data-theme', theme);
  themeToggle.innerHTML = theme === 'dark' ? '&#9790;' : '&#9788;';
  localStorage.setItem(THEME_KEY, theme);
}

themeToggle.addEventListener('click', () => {
  applyTheme(currentTheme === 'dark' ? 'light' : 'dark');
});


// =============================================================================
// VIEWS & NAVIGATION
// =============================================================================

const views = ['capture', 'review', 'timeline'];
let currentView = 'capture';

function switchView(v) {
  currentView = v;
  views.forEach(x => document.getElementById('view-' + x).classList.toggle('hidden', x !== v));
  document.querySelectorAll('#nav-desktop button, #nav-mobile button').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.view === v);
  });
  if (v === 'review')   renderReview();
  if (v === 'timeline') renderTimeline();
  if (v === 'capture')  document.getElementById('capture-input').focus();
  updateBadge();
  updateStats();
}

function renderCurrentView() {
  if (currentView === 'review')   renderReview();
  if (currentView === 'timeline') renderTimeline();
}

document.querySelectorAll('#nav-desktop button, #nav-mobile button').forEach(btn => {
  btn.addEventListener('click', () => switchView(btn.dataset.view));
});


// =============================================================================
// CAPTURE VIEW
// =============================================================================

const captureInput  = document.getElementById('capture-input');
const tagInput      = document.getElementById('tag-input');
const tagContainer  = document.getElementById('tag-container');
const tagDropdown   = document.getElementById('tag-dropdown');
const captureFlash  = document.getElementById('capture-flash');
const charCount     = document.getElementById('char-count');
const dateOverride  = document.getElementById('date-override');

let activeTags       = [];
let selectedCategory = '';

// Date helpers
function setDateNow() {
  const now    = new Date();
  const offset = now.getTimezoneOffset();
  const local  = new Date(now.getTime() - offset * 60000);
  dateOverride.value = local.toISOString().slice(0, 16);
}

setDateNow();

document.getElementById('date-now-btn').addEventListener('click', setDateNow);

document.getElementById('date-yest-btn').addEventListener('click', () => {
  const d      = new Date();
  d.setDate(d.getDate() - 1);
  const offset = d.getTimezoneOffset();
  const local  = new Date(d.getTime() - offset * 60000);
  dateOverride.value = local.toISOString().slice(0, 16);
  showFlash('Set to Yesterday');
});

// Character count
captureInput.addEventListener('input', () => {
  charCount.textContent = captureInput.value.length;
});

// Category chip selection (toggle)
document.querySelectorAll('#category-bar .cat-chip').forEach(chip => {
  chip.addEventListener('click', () => {
    const cat = chip.dataset.cat;
    if (selectedCategory === cat) {
      selectedCategory = '';
      chip.classList.remove('selected');
    } else {
      selectedCategory = cat;
      document.querySelectorAll('#category-bar .cat-chip').forEach(x => x.classList.remove('selected'));
      chip.classList.add('selected');
    }
  });
});

// Tag chips rendering
function renderActiveTags() {
  tagContainer.querySelectorAll('.tag-chip').forEach(c => c.remove());
  activeTags.forEach((tag, i) => {
    const chip = document.createElement('div');
    chip.className = 'tag-chip';
    chip.innerHTML = eh(tag) + ` <span class="tag-remove" data-index="${i}">&times;</span>`;
    tagContainer.insertBefore(chip, tagInput);
  });
}

tagContainer.addEventListener('click', e => {
  if (e.target.classList.contains('tag-remove')) {
    activeTags.splice(parseInt(e.target.dataset.index), 1);
    renderActiveTags();
  } else if (e.target === tagContainer) {
    tagInput.focus();
  }
});

function addActiveTag(str) {
  const clean = str.trim();
  if (clean && !activeTags.includes(clean)) {
    activeTags.push(clean);
    renderActiveTags();
  }
  tagInput.value = '';
}

// Save the current capture
function doCapture() {
  const text = captureInput.value.trim();
  if (!text) { captureInput.focus(); return; }

  // Flush any half-typed tag
  if (tagInput.value.trim()) addActiveTag(tagInput.value);

  const date = dateOverride.value ? new Date(dateOverride.value).toISOString() : null;
  addItem(text, selectedCategory, [...activeTags], date);

  // Reset form
  captureInput.value = '';
  charCount.textContent = '0';
  activeTags = [];
  renderActiveTags();
  tagInput.value = '';
  tagDropdown.classList.remove('open');
  selectedCategory = '';
  document.querySelectorAll('#category-bar .cat-chip').forEach(c => c.classList.remove('selected'));
  setDateNow();

  showFlash('Saved to Inbox');
  captureInput.focus();
  updateBadge();
  updateStats();
}

document.getElementById('capture-btn').addEventListener('click', doCapture);

captureInput.addEventListener('keydown', e => {
  if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
    e.preventDefault();
    doCapture();
  }
});


// =============================================================================
// TAG AUTOCOMPLETE (reusable for capture and search)
// =============================================================================

function setupTagAutocomplete(input, dropdown, onSelect) {
  let highlightIndex = -1;

  function renderDropdown() {
    const val     = input.value.toLowerCase();
    const matches = data.tags.filter(t => t.toLowerCase().includes(val));
    let html = matches.map((t, i) =>
      `<div class="tag-option" data-tag="${ea(t)}" data-index="${i}">${eh(t)}</div>`
    ).join('');

    // Offer to create a new tag if it doesn't exist yet
    if (val && !data.tags.some(t => t.toLowerCase() === val)) {
      html += `<div class="tag-option" style="color:var(--accent)" data-tag="${ea(input.value.trim())}" data-index="${matches.length}">+ Create "${eh(input.value.trim())}"</div>`;
    }

    dropdown.innerHTML = html;
    highlightIndex = -1;
    dropdown.classList.toggle('open', !!html);
  }

  function selectTag(tag) {
    if (onSelect) onSelect(tag);
    else input.value = tag;
    dropdown.classList.remove('open');
  }

  input.addEventListener('input', renderDropdown);
  input.addEventListener('focus', renderDropdown);

  input.addEventListener('keydown', e => {
    const opts = dropdown.querySelectorAll('.tag-option');

    if (e.key === 'Enter') {
      if (dropdown.classList.contains('open') && highlightIndex >= 0) {
        e.preventDefault();
        selectTag(opts[highlightIndex].dataset.tag);
      } else if (input.value.trim()) {
        e.preventDefault();
        if (onSelect) onSelect(input.value.trim());
      }
    } else if (e.key === 'ArrowDown') {
      if (!dropdown.classList.contains('open')) return;
      e.preventDefault();
      highlightIndex = Math.min(highlightIndex + 1, opts.length - 1);
      opts.forEach((o, i) => o.classList.toggle('highlighted', i === highlightIndex));
    } else if (e.key === 'ArrowUp') {
      if (!dropdown.classList.contains('open')) return;
      e.preventDefault();
      highlightIndex = Math.max(highlightIndex - 1, 0);
      opts.forEach((o, i) => o.classList.toggle('highlighted', i === highlightIndex));
    } else if (e.key === 'Escape') {
      dropdown.classList.remove('open');
    } else if (e.key === ',' && onSelect) {
      e.preventDefault();
      if (input.value.trim()) onSelect(input.value.trim());
    }
  });

  dropdown.addEventListener('click', e => {
    const opt = e.target.closest('.tag-option');
    if (opt) selectTag(opt.dataset.tag);
  });

  document.addEventListener('click', e => {
    if (!input.contains(e.target) && !dropdown.contains(e.target) && !e.target.closest('.tag-container')) {
      dropdown.classList.remove('open');
    }
  });
}

setupTagAutocomplete(tagInput, tagDropdown, tag => addActiveTag(tag));

// Search bar
document.getElementById('search-clear').addEventListener('click', () => {
  document.getElementById('search-input').value = '';
  document.getElementById('search-wrap').classList.remove('has-value');
  renderTimeline();
});

document.getElementById('search-input').addEventListener('input', function () {
  document.getElementById('search-wrap').classList.toggle('has-value', !!this.value);
  renderTimeline();
});


// =============================================================================
// REVIEW VIEW
// =============================================================================

function renderReview() {
  const list  = document.getElementById('review-list');
  const items = getUncategorised();
  document.getElementById('review-count').textContent = items.length + ' left';

  if (!items.length) {
    list.innerHTML = `
      <div class="review-empty">
        <div class="review-empty-icon">&#10024;</div>
        <h3>All caught up</h3>
        <p>No new moments for ${eh(activeChild)}.</p>
      </div>`;
    return;
  }

  list.innerHTML = items.map(item => `
    <div class="item-card" data-id="${ea(item.id)}">
      <textarea class="item-text-edit" data-id="${ea(item.id)}">${et(item.text)}</textarea>
      <div class="review-cats">
        ${CATEGORIES.map(c => `
          <button class="review-cat-btn ${item.category === c ? 'selected' : ''}" data-cat="${c}" data-id="${ea(item.id)}">
            ${c.charAt(0).toUpperCase() + c.slice(1)}
          </button>`).join('')}
      </div>
      <div class="item-footer">
        <div class="item-meta">
          ${(item.tags || []).map(t => `<span class="item-tag">${eh(t)}</span>`).join('')}
          <span>${formatTime(item.createdAt)}</span>
        </div>
        <button class="icon-btn delete" data-action="delete" data-id="${ea(item.id)}" title="Remove">
          <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
        </button>
      </div>
    </div>`).join('');

  // Assign category
  list.querySelectorAll('.review-cat-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      updateItem(btn.dataset.id, { category: btn.dataset.cat });
      renderReview();
      updateBadge();
      updateStats();
    });
  });

  // Delete
  list.querySelectorAll('.icon-btn.delete').forEach(btn => {
    btn.addEventListener('click', () => {
      const removed = deleteItem(btn.dataset.id);
      if (removed) pushUndo('Removed', removed);
      renderReview();
      updateBadge();
      updateStats();
    });
  });

  // Auto-resize textareas and save edits on blur
  list.querySelectorAll('textarea.item-text-edit').forEach(ta => {
    autoSize(ta);
    ta.addEventListener('input', () => autoSize(ta));
    ta.addEventListener('blur', () => {
      const item = data.items.find(i => i.id === ta.dataset.id);
      if (item && item.text !== ta.value) updateItem(ta.dataset.id, { text: ta.value.trim() });
    });
  });
}

function autoSize(el) {
  el.style.height = 'auto';
  el.style.height = el.scrollHeight + 'px';
}


// =============================================================================
// TIMELINE VIEW
// =============================================================================

let activeCat = 'all';

document.querySelectorAll('#cat-filters .cat-filter-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    activeCat = btn.dataset.cat;
    // Reset all filter buttons then apply the correct active class
    document.querySelectorAll('#cat-filters .cat-filter-btn').forEach(x => x.className = 'cat-filter-btn');
    const classMap = {
      all: 'active-all', quote: 'active-quote', first: 'active-first',
      funny: 'active-funny', neat: 'active-neat', note: 'active-note',
      uncategorised: 'active-all',
    };
    btn.classList.add(classMap[activeCat] || 'active-all');
    renderTimeline();
  });
});

document.getElementById('sort-select').addEventListener('change', () => renderTimeline());

function renderTimeline() {
  const query   = document.getElementById('search-input').value;
  const sort    = document.getElementById('sort-select').value;
  const results = searchItems(query, null, activeCat, sort);
  const list    = document.getElementById('timeline-list');

  if (!results.length) {
    list.innerHTML = `
      <div class="review-empty">
        <div class="review-empty-icon">&#128221;</div>
        <h3>No moments found</h3>
        <p>Capture something for ${eh(activeChild)}.</p>
      </div>`;
    return;
  }

  const groups = groupByDate(results);
  let html = '';

  for (const [label, items] of groups) {
    html += `<div class="date-group-label">${eh(label)}</div>`;
    html += items.map(item => {
      const catClass = item.category || '';
      const catLabel = item.category
        ? item.category.charAt(0).toUpperCase() + item.category.slice(1)
        : 'Uncategorised';
      const isQuote = item.category === 'quote';
      const displayText = isQuote
        ? `<span class="quote-mark">&ldquo;</span>${eh(item.text)}<span class="quote-mark">&rdquo;</span>`
        : eh(item.text);

      return `
        <div class="item-card ${item.pinned ? 'pinned' : ''}" data-id="${ea(item.id)}">
          <div class="item-text">
            ${item.pinned ? '<span style="color:var(--accent);margin-right:4px">&#9873;</span> ' : ''}
            ${displayText}
          </div>
          <div class="item-footer">
            <div class="item-meta">
              <span class="cat-badge ${catClass}">${catLabel}</span>
              ${(item.tags || []).map(t => `<span class="item-tag">${eh(t)}</span>`).join('')}
              <span>${formatTime(item.createdAt)}</span>
            </div>
            <div class="item-actions">
              <button class="icon-btn ${item.pinned ? 'active-pin' : ''}" data-action="pin" data-id="${ea(item.id)}">
                <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor"><path d="M16 9V4h1c.55 0 1-.45 1-1s-.45-1-1-1H7c-.55 0-1 .45-1 1s.45 1 1 1h1v5c0 1.66-1.34 3-3 3v2h5.97v7l1 1 1-1v-7H19v-2c-1.66 0-3-1.34-3-3z"/></svg>
              </button>
              <button class="icon-btn delete" data-action="delete" data-id="${ea(item.id)}">
                <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
              </button>
            </div>
          </div>
        </div>`;
    }).join('');
  }

  list.innerHTML = html;

  list.querySelectorAll('.icon-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const id     = btn.dataset.id;
      const action = btn.dataset.action;
      if (action === 'delete') {
        const removed = deleteItem(id);
        if (removed) pushUndo('Deleted', removed);
      } else if (action === 'pin') {
        togglePin(id);
      }
      renderTimeline();
      updateBadge();
      updateStats();
    });
  });
}

function groupByDate(items) {
  const groups    = new Map();
  const now       = new Date();
  const today     = new Date(now.getFullYear(), now.getMonth(), now.getDate());
  const yesterday = new Date(today); yesterday.setDate(today.getDate() - 1);
  const weekAgo   = new Date(today); weekAgo.setDate(today.getDate() - 7);

  items.forEach(item => {
    const d = new Date(item.createdAt);
    let label;
    if (d >= today)     label = 'Today';
    else if (d >= yesterday) label = 'Yesterday';
    else if (d >= weekAgo)   label = 'This Week';
    else label = d.toLocaleDateString('en-GB', { month: 'long', year: 'numeric' });

    if (!groups.has(label)) groups.set(label, []);
    groups.get(label).push(item);
  });

  return groups;
}


// =============================================================================
// STATS & UI HELPERS
// =============================================================================

function updateBadge() {
  const count = getUncategorised().length;
  ['review-badge-desk', 'review-badge-mob'].forEach(id => {
    const el = document.getElementById(id);
    el.textContent = count;
    el.classList.toggle('hidden', count === 0);
  });
}

function updateStats() {
  const childItems  = getChildItems();
  const deletedCount = data.items.filter(i => i._deleted).length;

  let text = childItems.length + ' moments';
  if (data.children.length > 1) text += ' (' + getActiveItems().length + ' total)';
  if (deletedCount > 0) text += ' · ' + deletedCount + ' in trash';

  document.getElementById('stats-text').textContent = text;
  document.getElementById('purge-btn').style.display = deletedCount > 0 ? '' : 'none';
}

// HTML-escape for inserting user content into innerHTML
function eh(str) {
  if (typeof str !== 'string') return '';
  const div = document.createElement('div');
  div.textContent = str;
  return div.innerHTML;
}

// HTML-escape for use in attribute values (double-quoted)
function ea(str) {
  if (typeof str !== 'string') return '';
  return str
    .replace(/&/g, '&amp;').replace(/"/g, '&quot;')
    .replace(/'/g, '&#39;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
}

// HTML-escape for textarea content
function et(str) {
  if (typeof str !== 'string') return '';
  return str
    .replace(/&/g, '&amp;').replace(/</g, '&lt;')
    .replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
}

function formatTime(iso) {
  const d    = new Date(iso);
  const now  = new Date();
  const diff = now - d;
  if (diff < 0)          return d.toLocaleDateString();
  if (diff < 60000)      return 'just now';
  if (diff < 3600000)    return Math.floor(diff / 60000) + 'm ago';
  if (diff < 86400000)   return Math.floor(diff / 3600000) + 'h ago';
  if (diff < 172800000)  return 'yesterday';
  return d.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' });
}

function showFlash(text) {
  document.getElementById('flash-text').textContent = text;
  captureFlash.classList.add('show');
  setTimeout(() => captureFlash.classList.remove('show'), 1500);
}


// =============================================================================
// MODAL
// =============================================================================

let modalCallback = null;

const modal = {
  overlay: document.getElementById('modal-overlay'),
  title:   document.getElementById('modal-title'),
  body:    document.getElementById('modal-body'),
  content: document.getElementById('modal-content'),
  cancel:  document.getElementById('modal-cancel'),
  confirm: document.getElementById('modal-confirm'),

  open(titleText, bodyText, buildContent, onConfirm, confirmLabel, isDanger) {
    modal.title.textContent   = titleText;
    modal.body.textContent    = bodyText;
    modal.content.innerHTML   = '';
    if (buildContent) buildContent(modal.content);
    modal.confirm.textContent = confirmLabel || 'Confirm';
    modal.confirm.className   = isDanger ? 'modal-btn confirm-danger' : 'modal-btn primary';
    modal.confirm.classList.remove('hidden');
    modal.cancel.textContent  = 'Cancel';
    modal.overlay.classList.add('open');
    modalCallback = onConfirm;
    // Auto-focus first input if present
    const firstInput = modal.content.querySelector('input');
    if (firstInput) setTimeout(() => firstInput.focus(), 100);
  },

  close() {
    modal.overlay.classList.remove('open');
    modalCallback = null;
  },
};

modal.cancel.addEventListener('click', modal.close);
modal.confirm.addEventListener('click', () => { if (modalCallback) modalCallback(); modal.close(); });
modal.overlay.addEventListener('click', e => { if (e.target === modal.overlay) modal.close(); });


// =============================================================================
// SETTINGS ACTIONS
// =============================================================================

// Backup — download full data as JSON
document.getElementById('export-btn').addEventListener('click', () => {
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
  const url  = URL.createObjectURL(blob);
  const a    = document.createElement('a');
  a.href     = url;
  a.download = 'pocketpip-' + new Date().toISOString().slice(0, 10) + '.json';
  a.click();
  URL.revokeObjectURL(url);
});

// Restore — import from JSON backup (merges by id, won't duplicate)
document.getElementById('import-btn').addEventListener('click', () => {
  document.getElementById('import-file').click();
});

document.getElementById('import-file').addEventListener('change', e => {
  const file = e.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = () => {
    try {
      const imported = JSON.parse(reader.result);
      if (!imported.items || !Array.isArray(imported.items)) throw new Error('Invalid');

      const existingIds = new Set(data.items.map(i => i.id));
      let count = 0;

      imported.items.forEach(i => {
        if (existingIds.has(i.id)) return; // skip duplicates
        // Normalise the imported item
        if (!Array.isArray(i.tags)) i.tags = i.tag ? [i.tag] : [];
        if (!i.category)  i.category  = '';
        if (!i.createdAt) i.createdAt = new Date().toISOString();
        if (!i.childName) i.childName = activeChild;
        i.pinned = !!i.pinned;
        delete i.tag;
        data.items.push(i);
        count++;
      });

      if (Array.isArray(imported.children)) {
        imported.children.forEach(c => { if (!data.children.includes(c)) data.children.push(c); });
      }
      if (Array.isArray(imported.tags)) {
        imported.tags.forEach(t => { if (!data.tags.includes(t)) data.tags.push(t); });
      }

      data.items.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
      saveData(data);
      renderChildDropdown();
      renderCurrentView();
      showFlash('Imported ' + count + ' moments');
    } catch (err) {
      alert('Invalid backup file.');
    }
  };
  reader.readAsText(file);
  e.target.value = '';
});

// Reset — wipe all local data (cloud data stays until next sync)
document.getElementById('clear-btn').addEventListener('click', () => {
  modal.open(
    'Reset App?',
    'Deletes all data locally. Cloud data remains unless synced.',
    ct => {
      const inp = document.createElement('input');
      inp.type = 'text';
      inp.className = 'modal-input';
      inp.placeholder = 'Type DELETE';
      inp.addEventListener('input', () => {
        modal.confirm.disabled    = inp.value !== 'DELETE';
        modal.confirm.style.opacity = inp.value === 'DELETE' ? '1' : '0.4';
      });
      ct.appendChild(inp);
    },
    () => {
      data = defaultData();
      saveData(data);
      activeChild = 'Malcolm';
      localStorage.setItem(ACTIVE_CHILD_KEY, activeChild);
      setActiveChild(activeChild);
      renderCurrentView();
    },
    'Delete',
    true
  );
  modal.confirm.disabled      = true;
  modal.confirm.style.opacity = '0.4';
});

// Empty trash — permanently remove soft-deleted items
document.getElementById('purge-btn').addEventListener('click', () => {
  const count = data.items.filter(i => i._deleted).length;
  modal.open(
    'Empty trash?',
    'Permanently remove ' + count + ' items.',
    null,
    () => { purgeAllDeleted(); renderCurrentView(); showFlash('Trash emptied'); },
    'Empty',
    true
  );
});

// Cloud settings
document.getElementById('cloud-btn').addEventListener('click', () => {
  modal.open(
    'Cloud Sync',
    'Connect to your Google Apps Script to sync between devices.',
    ct => {
      const urlLabel = document.createElement('label');
      urlLabel.textContent = 'URL';
      urlLabel.style.fontSize = '12px';
      ct.appendChild(urlLabel);

      const urlInput = document.createElement('input');
      urlInput.type = 'text';
      urlInput.className = 'modal-input';
      urlInput.value = cloudUrl;
      urlInput.id = 'cloud-url';
      urlInput.placeholder = 'https://script.google.com/macros/s/…';
      ct.appendChild(urlInput);

      const keyLabel = document.createElement('label');
      keyLabel.textContent = 'Secret Key (optional)';
      keyLabel.style.fontSize = '12px';
      ct.appendChild(keyLabel);

      const keyInput = document.createElement('input');
      keyInput.type = 'password';
      keyInput.className = 'modal-input';
      keyInput.value = getCloudSecret();
      keyInput.id = 'cloud-key';
      keyInput.placeholder = 'Leave blank if you did not set one';
      ct.appendChild(keyInput);

      // Inline test button
      const testWrap = document.createElement('div');
      testWrap.style.cssText = 'display:flex;gap:8px;align-items:center;margin-bottom:8px';

      const testBtn = document.createElement('button');
      testBtn.className = 'subtle-btn';
      testBtn.type = 'button';
      testBtn.style.cssText = 'font-size:12px;white-space:nowrap';
      testBtn.textContent = 'Test Connection';

      const testResult = document.createElement('span');
      testResult.style.cssText = 'font-size:12px;line-height:1.3;color:var(--text-secondary)';

      testWrap.appendChild(testBtn);
      testWrap.appendChild(testResult);
      ct.appendChild(testWrap);

      testBtn.addEventListener('click', async () => {
        testBtn.textContent = 'Testing…';
        testBtn.disabled = true;
        testResult.textContent = '';
        const result = await testCloudConnection(urlInput.value.trim(), keyInput.value.trim());
        testBtn.textContent = 'Test Connection';
        testBtn.disabled = false;
        testResult.style.color = result.ok ? 'var(--cat-first)' : 'var(--danger)';
        testResult.textContent = (result.ok ? '✓ ' : '✗ ') + result.msg;
      });
    },
    () => {
      const url = document.getElementById('cloud-url').value.trim();
      const key = document.getElementById('cloud-key').value.trim();
      if (url) {
        localStorage.setItem(CLOUD_URL_KEY, url);
        localStorage.setItem(CLOUD_KEY_STORAGE, key);
        cloudUrl = url;
        fetchCloudData();
      } else {
        localStorage.removeItem(CLOUD_URL_KEY);
        localStorage.removeItem(CLOUD_KEY_STORAGE);
        cloudUrl = '';
        setSyncStatus('', 'No cloud');
      }
    },
    'Save'
  );
});

// Sync diagnostics
document.getElementById('diagnose-btn').addEventListener('click', () => showSyncDiagnostics());


// =============================================================================
// INIT
// =============================================================================

setActiveChild(activeChild);
renderChildDropdown();
updateBadge();
updateStats();

// Only auto-focus the text input on desktop — on mobile the keyboard popping
// up immediately on load is jarring
if (window.innerWidth > 600) captureInput.focus();

</script>
</body>
</html>
